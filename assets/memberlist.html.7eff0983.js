import{r as e,o,a as t,b as n,e as p,F as r,g as a,f as s}from"./app.2025f35b.js";import{_ as c,a as D,b as i,c as y,d as b,e as u,f as m,g as C}from"./memberlist.6d5ad7c0.js";import{_ as d}from"./plugin-vue_export-helper.21dcd24c.js";const h={},A=a(`<h1 id="deep-dive-into-go-doudou-s-built-in-service-registry-and-discovery-component" tabindex="-1"><a class="header-anchor" href="#deep-dive-into-go-doudou-s-built-in-service-registry-and-discovery-component" aria-hidden="true">#</a> Deep Dive into go-doudou&#39;s Built-in Service Registry and Discovery Component</h1><p>go-doudou is a microservice framework developed in Go language that was open-sourced in early 2021. It initially built a decentralized service registration and discovery mechanism based on the SWIM gossip protocol that is integrated into the go-doudou framework and ready to use out of the box, using the open-source memberlist library from HashiCorp. The SWIM Gossip protocol is a weakly consistent protocol that not only has decentralized characteristics but also includes mechanisms for service registration, node health checks, and message broadcasting, making it very suitable as middleware for service registration and discovery.</p><h2 id="practical-example" tabindex="-1"><a class="header-anchor" href="#practical-example" aria-hidden="true">#</a> Practical Example</h2><p>We&#39;ll demonstrate usage through a practical example that includes a complete set of front-end and back-end services for uploading text files to generate word cloud images.</p><h3 id="development-environment" tabindex="-1"><a class="header-anchor" href="#development-environment" aria-hidden="true">#</a> Development Environment</h3><p>Docker and docker-compose development environments are required. All microservices need to be packaged as docker images and then started using docker-compose commands.</p><h3 id="download-the-code" tabindex="-1"><a class="header-anchor" href="#download-the-code" aria-hidden="true">#</a> Download the Code</h3><p>After cloning the repository source code to your local machine, please switch to the wordcloud folder.</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">git clone git@github.com:unionj-cloud/go-doudou-tutorials.git
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="build-the-images" tabindex="-1"><a class="header-anchor" href="#build-the-images" aria-hidden="true">#</a> Build the Images</h3><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">make docker
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="start-the-entire-microservice-system" tabindex="-1"><a class="header-anchor" href="#start-the-entire-microservice-system" aria-hidden="true">#</a> Start the Entire Microservice System</h3><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">make up
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="initialize-minio" tabindex="-1"><a class="header-anchor" href="#initialize-minio" aria-hidden="true">#</a> Initialize Minio</h3>`,14),f=s("This example uses minio to store user-uploaded files, which requires some initialization work. First, open "),g={href:"http://localhost:9001/",target:"_blank",rel:"noopener noreferrer"},E=s("http://localhost:9001/"),v=s(", then log in with the account and password minio/minio123, create a bucket called wordcloud, set "),F=n("code",null,"Access Policy",-1),k=s(" to "),w=n("code",null,"public",-1),N=s(", and finally create an "),P=n("code",null,"access key",-1),q=s(": testkey and "),M=n("code",null,"access secret",-1),B=s(": testsecret."),x=a('<p><img src="'+c+'" alt="go-doudou"><img src="'+D+'" alt="go-doudou"><img src="'+i+'" alt="go-doudou"><img src="'+y+'" alt="go-doudou"><img src="'+b+'" alt="go-doudou"></p><h3 id="using-the-system" tabindex="-1"><a class="header-anchor" href="#using-the-system" aria-hidden="true">#</a> Using the System</h3>',2),S=s("Open "),_={href:"http://localhost:3100/",target:"_blank",rel:"noopener noreferrer"},I=s("http://localhost:3100/"),T=s(", log in with the default account and password jackchen/1234, then upload any text format file. After processing, you will see the word cloud image output on the page."),V=a('<p><img src="'+u+`" alt="go-doudou"></p><h3 id="architecture-description" tabindex="-1"><a class="header-anchor" href="#architecture-description" aria-hidden="true">#</a> Architecture Description</h3><p>In this practical example, the frontend is handled by a UI service developed based on the <code>vue-vben-admin</code> framework (since the frontend technology stack is not the focus of this article, we won&#39;t elaborate further), and the backend consists of 5 RESTful microservices. Please see the comments below for specific explanations.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  wordcloud git:(master) \u2717 tree -L 1</span></span>
<span class="line"><span style="color:#DCDCAA;">.</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 Makefile</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 README.md</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 alertmanager</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 ddosify</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 dingtalkalert</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 docker-compose.yml</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 esdata</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 filebeat.yml</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 grafana</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 minio</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 my</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 prometheus</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 screencapture1.png</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 screencapture2.png</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 shellscripts</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 sqlscripts</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 wordcloud-bff  </span><span style="color:#6A9955;"># BFF service, providing a single interface entry point for the frontend, while tailoring and formatting data for frontend requirements</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 wordcloud-maker  </span><span style="color:#6A9955;"># Maker service, responsible for generating word cloud images based on the word frequency statistics of the text</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 wordcloud-seg  </span><span style="color:#6A9955;"># Seg service, responsible for tokenizing Chinese and English text content and calculating word frequency</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 wordcloud-task  </span><span style="color:#6A9955;"># Task service, responsible for storing and querying word cloud image tasks created by users</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500 wordcloud-ui</span></span>
<span class="line"><span style="color:#D4D4D4;">\u2514\u2500\u2500 wordcloud-user  </span><span style="color:#6A9955;"># User service, responsible for registration, login, and token generation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">16 directories, 6 files</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="service-list" tabindex="-1"><a class="header-anchor" href="#service-list" aria-hidden="true">#</a> Service List</h3>`,5),R=s("Readers can open "),L={href:"http://localhost:6060/go-doudou/registry",target:"_blank",rel:"noopener noreferrer"},U=s("http://localhost:6060/go-doudou/registry"),W=s(" to view the service list. You need to enter HTTP basic account and password admin/admin."),z=a('<p><img src="'+m+`" alt="go-doudou"></p><h3 id="code-analysis" tabindex="-1"><a class="header-anchor" href="#code-analysis" aria-hidden="true">#</a> Code Analysis</h3><p>Taking the BFF service as an example, let&#39;s look at the service registration and discovery related code. Please refer to the comments below for specific explanations.</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">package</span><span style="color:#D4D4D4;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">import</span><span style="color:#D4D4D4;"> (</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Load configuration from environment variables</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// User service http request client</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">userClient</span><span style="color:#D4D4D4;"> *userclient.UsersvcClient</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Maker service http request client</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">makerClient</span><span style="color:#D4D4D4;"> *makerclient.WordcloudMakerClient</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Task service http request client</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">taskClient</span><span style="color:#D4D4D4;"> *taskclient.WordcloudTaskClient</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Read the service mode from environment variables, monolithic or microservice</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// The environment variable name and value can be completely customized, not related to the go-doudou framework</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// The distinction of service modes is just for convenient local development</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;GDD_MODE&quot;</span><span style="color:#D4D4D4;">) == </span><span style="color:#CE9178;">&quot;micro&quot;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Service registration</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			logrus.</span><span style="color:#DCDCAA;">Panicln</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Service offline, release resources</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Create a client load balancer based on go-doudou&#39;s built-in service registration and discovery mechanism</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Client load balancer for User service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">userProvider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewMemberlistServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-usersvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Create an http request client instance for User service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">userClient</span><span style="color:#D4D4D4;"> = userclient.</span><span style="color:#DCDCAA;">NewUsersvcClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(userProvider))</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Client load balancer for Maker service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makerProvider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewMemberlistServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-makersvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// http request client instance for Maker service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makerClient</span><span style="color:#D4D4D4;"> = makerclient.</span><span style="color:#DCDCAA;">NewWordcloudMakerClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(makerProvider))</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Client load balancer for Task service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">taskProvider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewMemberlistServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-tasksvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// http request client instance for Task service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">taskClient</span><span style="color:#D4D4D4;"> = taskclient.</span><span style="color:#DCDCAA;">NewWordcloudTaskClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(taskProvider))</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Direct connection http request client instance for User service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">userClient</span><span style="color:#D4D4D4;"> = userclient.</span><span style="color:#DCDCAA;">NewUsersvcClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Direct connection http request client instance for Maker service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makerClient</span><span style="color:#D4D4D4;"> = makerclient.</span><span style="color:#DCDCAA;">NewWordcloudMakerClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Direct connection http request client instance for Task service</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">taskClient</span><span style="color:#D4D4D4;"> = taskclient.</span><span style="color:#DCDCAA;">NewWordcloudTaskClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Enable Jaeger call chain monitoring</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">tracer</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">closer</span><span style="color:#D4D4D4;"> := tracing.</span><span style="color:#DCDCAA;">Init</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> closer.</span><span style="color:#DCDCAA;">Close</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	opentracing.</span><span style="color:#DCDCAA;">SetGlobalTracer</span><span style="color:#D4D4D4;">(tracer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">rec</span><span style="color:#D4D4D4;"> := metrics.</span><span style="color:#DCDCAA;">NewPrometheusRecorder</span><span style="color:#D4D4D4;">(prometheus.DefaultRegisterer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Add circuit breakers, timeouts, retries, and other resilience and fault tolerance mechanisms and Prometheus metrics collection to User, Maker, and Task services</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">userClientProxy</span><span style="color:#D4D4D4;"> := userclient.</span><span style="color:#DCDCAA;">NewUsersvcClientProxy</span><span style="color:#D4D4D4;">(userClient, rec)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">makerClientProxy</span><span style="color:#D4D4D4;"> := makerclient.</span><span style="color:#DCDCAA;">NewWordcloudMakerClientProxy</span><span style="color:#D4D4D4;">(makerClient, rec)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">taskClientProxy</span><span style="color:#D4D4D4;"> := taskclient.</span><span style="color:#DCDCAA;">NewWordcloudTaskClientProxy</span><span style="color:#D4D4D4;">(taskClient, rec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Create minio client</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">endpoint</span><span style="color:#D4D4D4;"> := conf.BizConf.OssEndpoint</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">accessKeyID</span><span style="color:#D4D4D4;"> := conf.BizConf.OssKey</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">secretAccessKey</span><span style="color:#D4D4D4;"> := conf.BizConf.OssSecret</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">useSSL</span><span style="color:#D4D4D4;"> := </span><span style="color:#569CD6;">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Initialize minio client object.</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">minioClient</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := minio.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(endpoint, &amp;minio.Options{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Creds:  credentials.</span><span style="color:#DCDCAA;">NewStaticV4</span><span style="color:#D4D4D4;">(accessKeyID, secretAccessKey, </span><span style="color:#CE9178;">&quot;&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		Secure: useSSL,</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#DCDCAA;">panic</span><span style="color:#D4D4D4;">(err)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Inject User, Maker, Task service http request client instances, minio client instance</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudBff</span><span style="color:#D4D4D4;">(conf, minioClient, makerClientProxy, taskClientProxy, userClientProxy)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewWordcloudBffHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Auth</span><span style="color:#D4D4D4;">(userClientProxy))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">rdb</span><span style="color:#D4D4D4;"> := redis.</span><span style="color:#DCDCAA;">NewClient</span><span style="color:#D4D4D4;">(&amp;redis.Options{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Addr: fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">:6379&quot;</span><span style="color:#D4D4D4;">, conf.RedisConf.Host),</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">fn</span><span style="color:#D4D4D4;"> := redisrate.</span><span style="color:#DCDCAA;">LimitFn</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(ctx context.Context) ratelimit.Limit {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> ratelimit.</span><span style="color:#DCDCAA;">PerSecondBurst</span><span style="color:#D4D4D4;">(conf.ConConf.RatelimitRate, conf.ConConf.RatelimitBurst)</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Add bulkhead mechanism</span></span>
<span class="line"><span style="color:#D4D4D4;">		ddhttp.</span><span style="color:#DCDCAA;">BulkHead</span><span style="color:#D4D4D4;">(conf.ConConf.BulkheadWorkers, conf.ConConf.BulkheadMaxwaittime),</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Add redis-based rate limiter</span></span>
<span class="line"><span style="color:#D4D4D4;">		httpsrv.</span><span style="color:#DCDCAA;">RedisRateLimit</span><span style="color:#D4D4D4;">(rdb, fn),</span></span>
<span class="line"><span style="color:#D4D4D4;">	)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Start http service</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><h2 id="source-code-analysis" tabindex="-1"><a class="header-anchor" href="#source-code-analysis" aria-hidden="true">#</a> Source Code Analysis</h2><p>The go-doudou built-in service registry and discovery mechanism is developed based on the memberlist library and has been modified for microservice application scenarios. The memberlist library contains many treasures, and each time you read the source code, you gain new insights. Even if readers don&#39;t use this mechanism in their actual project development, it&#39;s still recommended to study it. Please first review the startup flow diagram, and later we will focus on code analysis of several important functions.</p><h3 id="startup-flow-diagram" tabindex="-1"><a class="header-anchor" href="#startup-flow-diagram" aria-hidden="true">#</a> Startup Flow Diagram</h3><p><img src="`+C+`" alt="go-doudou"></p><h3 id="registry-newnode" tabindex="-1"><a class="header-anchor" href="#registry-newnode" aria-hidden="true">#</a> registry.NewNode()</h3><p>In this function, go-doudou encapsulates the initialization processes for two mechanisms: one based on memberlist and another based on Nacos. It decides which mechanism to use based on configuration and supports using both mechanisms simultaneously.</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">(data ...</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;">{}) </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Read configuration from environment variable GDD_SERVICE_DISCOVERY_MODE</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">mode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> := </span><span style="color:#C586C0;">range</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">getModemap</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">switch</span><span style="color:#D4D4D4;"> mode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">case</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;nacos&quot;</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">			nacos.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">(data...)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">case</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;memberlist&quot;</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// Initialize memberlist mechanism</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">newNode</span><span style="color:#D4D4D4;">(data...)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">default</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">			logger.</span><span style="color:#DCDCAA;">Warn</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[go-doudou] unknown service discovery mode: </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, mode))</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="registry-newnode-1" tabindex="-1"><a class="header-anchor" href="#registry-newnode-1" aria-hidden="true">#</a> registry.newNode()</h3><p>This function creates a memberlist instance, and the startup flow diagram actually starts from here.</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">newNode</span><span style="color:#D4D4D4;">(data ...</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;">{}) </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Initialize memberlist configuration</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mconf</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">newConf</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Initialize HTTP-related configurations and metadata for the service itself, omitted here</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mmeta</span><span style="color:#D4D4D4;"> := mergedMeta{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Meta: nodeMeta{</span></span>
<span class="line"><span style="color:#D4D4D4;">			Service:       service,</span></span>
<span class="line"><span style="color:#D4D4D4;">			RouteRootPath: rr,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Port:          httpPort,</span></span>
<span class="line"><span style="color:#D4D4D4;">			RegisterAt:    &amp;now,</span></span>
<span class="line"><span style="color:#D4D4D4;">			GoVer:         runtime.</span><span style="color:#DCDCAA;">Version</span><span style="color:#D4D4D4;">(),</span></span>
<span class="line"><span style="color:#D4D4D4;">			GddVer:        buildinfo.GddVer,</span></span>
<span class="line"><span style="color:#D4D4D4;">			BuildUser:     buildinfo.BuildUser,</span></span>
<span class="line"><span style="color:#D4D4D4;">			BuildTime:     buildTime,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Weight:        weight,</span></span>
<span class="line"><span style="color:#D4D4D4;">		},</span></span>
<span class="line"><span style="color:#D4D4D4;">		Data: </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;">{}),</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(data) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">mmeta.Data</span><span style="color:#D4D4D4;"> = data[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">queue</span><span style="color:#D4D4D4;"> := &amp;memberlist.TransmitLimitedQueue{</span></span>
<span class="line"><span style="color:#D4D4D4;">		NumNodes:             numNodes,</span></span>
<span class="line"><span style="color:#D4D4D4;">		RetransmitMultGetter: retransmitMultGetter,</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">BroadcastQueue</span><span style="color:#D4D4D4;"> = queue</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mconf.Delegate</span><span style="color:#D4D4D4;"> = &amp;delegate{</span></span>
<span class="line"><span style="color:#D4D4D4;">		mmeta: mmeta,</span></span>
<span class="line"><span style="color:#D4D4D4;">		queue: queue,</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mconf.Events</span><span style="color:#D4D4D4;"> = events</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">error</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// createMemberlist actually calls memberlist.Create</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Written this way for unit testing</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">mlist</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createMemberlist</span><span style="color:#D4D4D4;">(mconf); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> errors.</span><span style="color:#DCDCAA;">Wrap</span><span style="color:#D4D4D4;">(err, </span><span style="color:#CE9178;">&quot;[go-doudou] Failed to create memberlist&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Join the cluster where the seed node is located</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">join</span><span style="color:#D4D4D4;">(); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		mlist.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> errors.</span><span style="color:#DCDCAA;">Wrap</span><span style="color:#D4D4D4;">(err, </span><span style="color:#CE9178;">&quot;[go-doudou] Node register failed&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">local</span><span style="color:#D4D4D4;"> := mlist.</span><span style="color:#DCDCAA;">LocalNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">baseUrl</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">BaseUrl</span><span style="color:#D4D4D4;">(local)</span></span>
<span class="line"><span style="color:#D4D4D4;">	logger.</span><span style="color:#DCDCAA;">Infof</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;memberlist created. local node is Node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">, providing </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;"> service at </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">, memberlist port </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">		local.Name, mmeta.Meta.Service, baseUrl, fmt.</span><span style="color:#DCDCAA;">Sprint</span><span style="color:#D4D4D4;">(local.Port))</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#DCDCAA;">registerConfigListener</span><span style="color:#D4D4D4;">(mconf)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="memberlist-newmemberlist" tabindex="-1"><a class="header-anchor" href="#memberlist-newmemberlist" aria-hidden="true">#</a> memberlist.NewMemberlist</h3><p>Creates a memberlist instance</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">NewMemberlist</span><span style="color:#D4D4D4;">(conf *Config) (*Memberlist, </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Check protocol version, go-doudou doesn&#39;t involve this logic</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.ProtocolVersion &lt; ProtocolVersionMin {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Protocol version &#39;</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&#39; too low. Must be in range: [</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">, </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">]&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">			conf.ProtocolVersion, ProtocolVersionMin, ProtocolVersionMax)</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.ProtocolVersion &gt; ProtocolVersionMax {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Protocol version &#39;</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&#39; too high. Must be in range: [</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">, </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">]&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">			conf.ProtocolVersion, ProtocolVersionMin, ProtocolVersionMax)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(conf.SecretKey) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.Keyring == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">keyring</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">NewKeyring</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, conf.SecretKey)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">conf.Keyring</span><span style="color:#D4D4D4;"> = keyring</span></span>
<span class="line"><span style="color:#D4D4D4;">		} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := conf.Keyring.</span><span style="color:#DCDCAA;">AddKey</span><span style="color:#D4D4D4;">(conf.SecretKey); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := conf.Keyring.</span><span style="color:#DCDCAA;">UseKey</span><span style="color:#D4D4D4;">(conf.SecretKey); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Log related configuration</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.LogOutput != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> &amp;&amp; conf.Logger != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Cannot specify both LogOutput and Logger. Please choose a single log configuration setting.&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">logDest</span><span style="color:#D4D4D4;"> := conf.LogOutput</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> logDest == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">logDest</span><span style="color:#D4D4D4;"> = os.Stderr</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">logger</span><span style="color:#D4D4D4;"> := conf.Logger</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> logger == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">logger</span><span style="color:#D4D4D4;"> = log.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(logDest, </span><span style="color:#CE9178;">&quot;&quot;</span><span style="color:#D4D4D4;">, log.LstdFlags)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// If the user doesn&#39;t provide a custom Transport, create a default one</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Responsible for listening to TCP and UDP messages</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">transport</span><span style="color:#D4D4D4;"> := conf.Transport</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> transport == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">nc</span><span style="color:#D4D4D4;"> := &amp;NetTransportConfig{</span></span>
<span class="line"><span style="color:#D4D4D4;">			BindAddrs: []</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">{conf.BindAddr},</span></span>
<span class="line"><span style="color:#D4D4D4;">			BindPort:  conf.BindPort,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Logger:    logger,</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// See comment below for details about the retry in here.</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makeNetRetry</span><span style="color:#D4D4D4;"> := </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(limit </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;">) (*NetTransport, </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">error</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">try</span><span style="color:#D4D4D4;"> := </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">; try &lt; limit; try++ {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">nt</span><span style="color:#D4D4D4;"> *NetTransport</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">nt</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">NewNetTransport</span><span style="color:#D4D4D4;">(nc); err == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">					</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> nt, </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">				}</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> strings.</span><span style="color:#DCDCAA;">Contains</span><span style="color:#D4D4D4;">(err.</span><span style="color:#DCDCAA;">Error</span><span style="color:#D4D4D4;">(), </span><span style="color:#CE9178;">&quot;address already in use&quot;</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">					logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[DEBUG] memberlist: Got bind error: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">					</span><span style="color:#C586C0;">continue</span></span>
<span class="line"><span style="color:#D4D4D4;">				}</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;failed to obtain an address: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">limit</span><span style="color:#D4D4D4;"> := </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.BindPort == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">limit</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">10</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// If the user doesn&#39;t specify BindPort, it will try 10 times to bind to an available port,</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// shared by both TCP and UDP</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">nt</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">makeNetRetry</span><span style="color:#D4D4D4;">(limit)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Could not set up network transport: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.BindPort == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">port</span><span style="color:#D4D4D4;"> := nt.</span><span style="color:#DCDCAA;">GetAutoBindPort</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">conf.BindPort</span><span style="color:#D4D4D4;"> = port</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">conf.AdvertisePort</span><span style="color:#D4D4D4;"> = port</span></span>
<span class="line"><span style="color:#D4D4D4;">			logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[DEBUG] memberlist: Using dynamic bind port </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, port)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">transport</span><span style="color:#D4D4D4;"> = nt</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">nodeAwareTransport</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">ok</span><span style="color:#D4D4D4;"> := transport.(NodeAwareTransport)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !ok {</span></span>
<span class="line"><span style="color:#D4D4D4;">		logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[DEBUG] memberlist: configured Transport is not a NodeAwareTransport and some features may not work as desired&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">nodeAwareTransport</span><span style="color:#D4D4D4;"> = &amp;shimNodeAwareTransport{transport}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Create and initialize memberlist instance</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">m</span><span style="color:#D4D4D4;"> := &amp;Memberlist{</span></span>
<span class="line"><span style="color:#D4D4D4;">		config:               conf,</span></span>
<span class="line"><span style="color:#D4D4D4;">		shutdownCh:           </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}),</span></span>
<span class="line"><span style="color:#D4D4D4;">		leaveBroadcast:       </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		transport:            nodeAwareTransport,</span></span>
<span class="line"><span style="color:#D4D4D4;">		handoffCh:            </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		highPriorityMsgQueue: list.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(),</span></span>
<span class="line"><span style="color:#D4D4D4;">		lowPriorityMsgQueue:  list.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(),</span></span>
<span class="line"><span style="color:#D4D4D4;">		nodeMap:              </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]*nodeState),</span></span>
<span class="line"><span style="color:#D4D4D4;">		nodeTimers:           </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]*suspicion),</span></span>
<span class="line"><span style="color:#D4D4D4;">		awareness:            </span><span style="color:#DCDCAA;">newAwareness</span><span style="color:#D4D4D4;">(conf.AwarenessMaxMultiplier),</span></span>
<span class="line"><span style="color:#D4D4D4;">		ackHandlers:          </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">uint32</span><span style="color:#D4D4D4;">]*ackHandler),</span></span>
<span class="line"><span style="color:#D4D4D4;">		broadcasts: &amp;TransmitLimitedQueue{RetransmitMultGetter: </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> conf.RetransmitMult</span></span>
<span class="line"><span style="color:#D4D4D4;">		}},</span></span>
<span class="line"><span style="color:#D4D4D4;">		logger: logger,</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">m.broadcasts.NumNodes</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">estNumNodes</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Refresh public Host and port</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := m.</span><span style="color:#DCDCAA;">refreshAdvertise</span><span style="color:#D4D4D4;">(); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Start TCP message listening goroutine</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">streamListen</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Start UDP message listening goroutine</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">packetListen</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Start goroutine to handle five types of messages sent via UDP: suspectMsg, aliveMsg, deadMsg, weightMsg, and userMsg</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">packetHandler</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m, </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br></div></div><h3 id="m-alivenode" tabindex="-1"><a class="header-anchor" href="#m-alivenode" aria-hidden="true">#</a> m.aliveNode</h3><p>This memberlist instance method is responsible for handling alive messages, which can either process messages from other nodes or handle messages when initializing itself to set its state as alive.</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (m *Memberlist) </span><span style="color:#DCDCAA;">aliveNode</span><span style="color:#D4D4D4;">(a *alive, notify </span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}, bootstrap </span><span style="color:#4EC9B0;">bool</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Lock to ensure thread safety</span></span>
<span class="line"><span style="color:#D4D4D4;">	m.nodeLock.</span><span style="color:#DCDCAA;">Lock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> m.nodeLock.</span><span style="color:#DCDCAA;">Unlock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Retrieve the node status value from m&#39;s dictionary-type node cache nodeMap using the node name in the alive message</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">state</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">ok</span><span style="color:#D4D4D4;"> := m.nodeMap[a.Node]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// If the local node has already actively left and the node mentioned in the alive message is itself, return directly</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// The go-doudou service node doesn&#39;t have an &quot;actively leave&quot; situation because the node list cache of each node</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// won&#39;t clear the node information that &quot;actively leaves&quot;, which would cause memory leaks</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">hasLeft</span><span style="color:#D4D4D4;">() &amp;&amp; a.Node == m.config.Name {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &gt;= </span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">pMin</span><span style="color:#D4D4D4;"> := a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">pMax</span><span style="color:#D4D4D4;"> := a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">pCur</span><span style="color:#D4D4D4;"> := a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> pMin == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> || pMax == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> || pMin &gt; pMax {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Ignoring an alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39; (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">) because protocol version(s) are wrong: </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> &lt;= </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> &lt;= </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> should be &gt;0&quot;</span><span style="color:#D4D4D4;">, a.Node, a.Addr, a.Port, pMin, pCur, pMax)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Alive callback function, the go-doudou framework doesn&#39;t use this, and no application scenario has been found yet</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.Alive != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &lt; </span><span style="color:#B5CEA8;">6</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: ignoring alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39; (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">) because Vsn is not present&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">				a.Node, a.Addr, a.Port)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;"> := &amp;Node{</span></span>
<span class="line"><span style="color:#D4D4D4;">			Name: a.Node,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Addr: a.Addr,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Port: a.Port,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Meta: a.Meta,</span></span>
<span class="line"><span style="color:#D4D4D4;">			PMin: a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			PMax: a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			PCur: a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			DMin: a.Vsn[</span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			DMax: a.Vsn[</span><span style="color:#B5CEA8;">4</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			DCur: a.Vsn[</span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := m.config.Alive.</span><span style="color:#DCDCAA;">NotifyAlive</span><span style="color:#D4D4D4;">(node); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: ignoring alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39;: </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">				a.Node, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Determine if this is a new node we haven&#39;t seen before; if so, add it to the local node cache dictionary</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">updatesNode</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">bool</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !ok {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Check if it&#39;s a blacklisted IP; if so, discard the message</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">errCon</span><span style="color:#D4D4D4;"> := m.config.</span><span style="color:#DCDCAA;">AddrAllowed</span><span style="color:#D4D4D4;">(a.Addr)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> errCon != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Rejected node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">): </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, a.Node, a.Addr, errCon)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Create and initialize node state</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state</span><span style="color:#D4D4D4;"> = &amp;nodeState{</span></span>
<span class="line"><span style="color:#D4D4D4;">			Node: Node{</span></span>
<span class="line"><span style="color:#D4D4D4;">				Name: a.Node,</span></span>
<span class="line"><span style="color:#D4D4D4;">				Addr: a.Addr,</span></span>
<span class="line"><span style="color:#D4D4D4;">				Port: a.Port,</span></span>
<span class="line"><span style="color:#D4D4D4;">				Meta: a.Meta,</span></span>
<span class="line"><span style="color:#D4D4D4;">			},</span></span>
<span class="line"><span style="color:#D4D4D4;">			State: StateDead,</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Protocol version compatibility related code, not relevant to go-doudou</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &gt; </span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">4</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// Put the node state into the node cache dictionary</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.nodeMap[a.Node] = state</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// Randomly select an offset, with the purpose of exchanging nodes later,</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// equivalent to shuffling the node list, to avoid consecutive node health check failures,</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// which would increase the overhead of the node health checking mechanism</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">n</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(m.nodes)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">offset</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">randomOffset</span><span style="color:#D4D4D4;">(n)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// First put this node state at the end, then swap positions with the node at offset</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.nodes</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.nodes, state)</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.nodes[offset], m.nodes[n] = m.nodes[n], m.nodes[offset]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// Perform atomic increment of node count</span></span>
<span class="line"><span style="color:#D4D4D4;">		atomic.</span><span style="color:#DCDCAA;">AddUint32</span><span style="color:#D4D4D4;">(&amp;m.numNodes, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// If we get here, it means the alive message is about a known node, so check if the new Host and port</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// are consistent with the old Host and port. If not, execute the logic below</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> state.Addr != a.Addr || state.Port != a.Port {</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// Check if the new Host is blacklisted</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">errCon</span><span style="color:#D4D4D4;"> := m.config.</span><span style="color:#DCDCAA;">AddrAllowed</span><span style="color:#D4D4D4;">(a.Addr)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> errCon != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Rejected IP update from </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> to </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> for node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">: </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, a.Node, state.Addr, a.Addr, errCon)</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// If DeadNodeReclaimTime is configured (i.e., how long a dead node must wait before it can declare itself</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// alive again with the same name but a different address), check if that time has passed.</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// If the time has passed, it can declare itself alive, just with a different Host or port</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">canReclaim</span><span style="color:#D4D4D4;"> := (m.config.DeadNodeReclaimTime &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#D4D4D4;">				time.</span><span style="color:#DCDCAA;">Since</span><span style="color:#D4D4D4;">(state.StateChange) &gt; m.config.DeadNodeReclaimTime)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#6A9955;">// If the node state in the cache is &quot;actively left&quot; or &quot;dead&quot; but can reclaim aliveness,</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// update the node state in the cache</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> state.State == StateLeft || (state.State == StateDead &amp;&amp; canReclaim) {</span></span>
<span class="line"><span style="color:#D4D4D4;">				m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[INFO] memberlist: Updating address for left or failed node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;"> from </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> to </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">					state.Name, state.Addr, state.Port, a.Addr, a.Port)</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#9CDCFE;">updatesNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">true</span></span>
<span class="line"><span style="color:#D4D4D4;">			} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">                </span><span style="color:#6A9955;">// If the conditions for reclaiming aliveness are not met, log a node conflict</span></span>
<span class="line"><span style="color:#D4D4D4;">				m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[ERR] memberlist: Conflicting address for </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">. Mine: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> Theirs: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> Old state: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">					state.Name, state.Addr, state.Port, a.Addr, a.Port, state.State)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#6A9955;">// If a node conflict callback is configured, call it</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.Conflict != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">					</span><span style="color:#9CDCFE;">other</span><span style="color:#D4D4D4;"> := Node{</span></span>
<span class="line"><span style="color:#D4D4D4;">						Name: a.Node,</span></span>
<span class="line"><span style="color:#D4D4D4;">						Addr: a.Addr,</span></span>
<span class="line"><span style="color:#D4D4D4;">						Port: a.Port,</span></span>
<span class="line"><span style="color:#D4D4D4;">						Meta: a.Meta,</span></span>
<span class="line"><span style="color:#D4D4D4;">					}</span></span>
<span class="line"><span style="color:#D4D4D4;">					m.config.Conflict.</span><span style="color:#DCDCAA;">NotifyConflict</span><span style="color:#D4D4D4;">(&amp;state.Node, &amp;other)</span></span>
<span class="line"><span style="color:#D4D4D4;">				}</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// If the Incarnation value in the alive message is less than or equal to the Incarnation value in the cache,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// and it&#39;s neither about the local node nor does it need to update the node cache, discard the message.</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// The Incarnation value serves as a kind of version control for node state, or an optimistic lock</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">isLocalNode</span><span style="color:#D4D4D4;"> := state.Name == m.config.Name</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> a.Incarnation &lt;= state.Incarnation &amp;&amp; !isLocalNode &amp;&amp; !updatesNode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// If the Incarnation value in the alive message is less than the Incarnation value in the cache</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// and it&#39;s about the local node, discard the message</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> a.Incarnation &lt; state.Incarnation &amp;&amp; isLocalNode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Delete the timer that suspects the node is dead</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#DCDCAA;">delete</span><span style="color:#D4D4D4;">(m.nodeTimers, a.Node)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Store the old state and meta data</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">oldState</span><span style="color:#D4D4D4;"> := state.State</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">oldMeta</span><span style="color:#D4D4D4;"> := state.Meta</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// If it&#39;s not initializing the local node state during startup but is about the local node,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// execute the logic below</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !bootstrap &amp;&amp; isLocalNode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// Calculate protocol version matrix</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">versions</span><span style="color:#D4D4D4;"> := []</span><span style="color:#4EC9B0;">uint8</span><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">			state.PMin, state.PMax, state.PCur,</span></span>
<span class="line"><span style="color:#D4D4D4;">			state.DMin, state.DMax, state.DCur,</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// If the Incarnation value in the alive message is the same as the Incarnation value in the node state cache,</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// we need special handling because this situation could arise from the following scenario:</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 1) Start with configuration C and join the cluster</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 2) Force quit/process killed/server shutdown</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 3) Restart with configuration C&#39; and join the cluster</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">//</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// In this case, both other nodes and the local node will see the same incarnation value,</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// but the node state may have changed. So we need to check for equality.</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// In most cases, we just need to ignore the message, but sometimes we might need to refute back.</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> a.Incarnation == state.Incarnation &amp;&amp;</span></span>
<span class="line"><span style="color:#D4D4D4;">			bytes.</span><span style="color:#DCDCAA;">Equal</span><span style="color:#D4D4D4;">(a.Meta, state.Meta) &amp;&amp;</span></span>
<span class="line"><span style="color:#D4D4D4;">			bytes.</span><span style="color:#DCDCAA;">Equal</span><span style="color:#D4D4D4;">(a.Vsn, versions) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.</span><span style="color:#DCDCAA;">refute</span><span style="color:#D4D4D4;">(state, a.Incarnation)</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Refuting an alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39; (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">) meta:(</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> VS </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">), vsn:(</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> VS </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">)&quot;</span><span style="color:#D4D4D4;">, a.Node, a.Addr, a.Port, a.Meta, state.Meta, a.Vsn, versions)</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Add the alive message for this node to the broadcast queue again, broadcasting to other nodes</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.</span><span style="color:#DCDCAA;">encodeBroadcastNotify</span><span style="color:#D4D4D4;">(a.Node, aliveMsg, a, notify)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// Update protocol version information, not relevant to go-doudou</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">4</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Update the node state in the cache and the Incarnation property</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Incarnation</span><span style="color:#D4D4D4;"> = a.Incarnation</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Meta</span><span style="color:#D4D4D4;"> = a.Meta</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Addr</span><span style="color:#D4D4D4;"> = a.Addr</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Port</span><span style="color:#D4D4D4;"> = a.Port</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> state.State != StateAlive {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.State</span><span style="color:#D4D4D4;"> = StateAlive</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.StateChange</span><span style="color:#D4D4D4;"> = time.</span><span style="color:#DCDCAA;">Now</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Update metrics monitoring items, used to calculate node health value,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// also calculated as a dimension when go-doudou dynamically calculates node weight</span></span>
<span class="line"><span style="color:#D4D4D4;">	metrics.</span><span style="color:#DCDCAA;">IncrCounter</span><span style="color:#D4D4D4;">([]</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">{</span><span style="color:#CE9178;">&quot;memberlist&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;msg&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;alive&quot;</span><span style="color:#D4D4D4;">}, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Execute relevant callback functions</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.Events != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> oldState == StateDead || oldState == StateLeft {</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// If the node state changes from &quot;dead&quot; or &quot;actively left&quot; to &quot;alive&quot;,</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// execute the Join event callback function</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.Node.State</span><span style="color:#D4D4D4;"> = state.State</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.config.Events.</span><span style="color:#DCDCAA;">NotifyJoin</span><span style="color:#D4D4D4;">(&amp;state.Node)</span></span>
<span class="line"><span style="color:#D4D4D4;">		} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> oldState == StateSuspect {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.Node.State</span><span style="color:#D4D4D4;"> = state.State</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// If the node state changes from &quot;suspected dead&quot; to &quot;alive&quot;,</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// execute the SuspectSateChange event callback function</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.config.Events.</span><span style="color:#DCDCAA;">NotifySuspectSateChange</span><span style="color:#D4D4D4;">(&amp;state.Node)</span></span>
<span class="line"><span style="color:#D4D4D4;">		} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !bytes.</span><span style="color:#DCDCAA;">Equal</span><span style="color:#D4D4D4;">(oldMeta, state.Meta) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#6A9955;">// If only metadata is updated, execute the Update event callback function</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.config.Events.</span><span style="color:#DCDCAA;">NotifyUpdate</span><span style="color:#D4D4D4;">(&amp;state.Node)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br></div></div><h3 id="m-schedule" tabindex="-1"><a class="header-anchor" href="#m-schedule" aria-hidden="true">#</a> m.schedule</h3><p>This method implements the core scheduling logic of memberlist.</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (m *Memberlist) </span><span style="color:#DCDCAA;">schedule</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Lock to ensure thread safety</span></span>
<span class="line"><span style="color:#D4D4D4;">	m.tickerLock.</span><span style="color:#DCDCAA;">Lock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> m.tickerLock.</span><span style="color:#DCDCAA;">Unlock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// If the timer task list is not empty, return</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(m.tickers) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Create an unbuffered channel for stopping timer tasks; when we need to stop the timer tasks, we close it</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">stopCh</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Create a node health check timer task</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.ProbeInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">t</span><span style="color:#D4D4D4;"> := time.</span><span style="color:#DCDCAA;">NewTicker</span><span style="color:#D4D4D4;">(m.config.ProbeInterval)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">triggerFuncDynamic</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() time.Duration {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m.config.ProbeInterval</span></span>
<span class="line"><span style="color:#D4D4D4;">		}, t, stopCh, m.probe)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.tickers</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.tickers, t)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Create a TCP-based timer task for synchronizing node lists with other nodes</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.PushPullInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">pushPullTrigger</span><span style="color:#D4D4D4;">(stopCh)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Create a timer task for broadcasting UDP messages</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.GossipInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> &amp;&amp; m.config.GossipNodes &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">t</span><span style="color:#D4D4D4;"> := time.</span><span style="color:#DCDCAA;">NewTicker</span><span style="color:#D4D4D4;">(m.config.GossipInterval)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">triggerFuncDynamic</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() time.Duration {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m.config.GossipInterval</span></span>
<span class="line"><span style="color:#D4D4D4;">		}, t, stopCh, m.gossip)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.tickers</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.tickers, t)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Create a timer task for dynamically calculating the local node weight and broadcasting it</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.WeightInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">t</span><span style="color:#D4D4D4;"> := time.</span><span style="color:#DCDCAA;">NewTicker</span><span style="color:#D4D4D4;">(m.config.WeightInterval)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">triggerFunc</span><span style="color:#D4D4D4;">(m.config.WeightInterval, t.C, stopCh, m.weight)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.tickers</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.tickers, t)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// If the timer task list is not empty, assign the just-created stopCh channel to the m variable&#39;s stopTick property</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(m.tickers) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.stopTick</span><span style="color:#D4D4D4;"> = stopCh</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion" aria-hidden="true">#</a> Conclusion</h2><p>This article has introduced go-doudou&#39;s built-in service registration and discovery mechanism based on the SWIM gossip protocol, demonstrated its basic usage through a practical example of generating word cloud images from uploaded text files, and provided an overview of the startup process with detailed explanations of the core source code. The aim is to help gophers better understand the internal mechanisms of the go-doudou microservice framework.</p><p>From the above code, we can see that go-doudou implements a decentralized service registration and discovery mechanism based on the gossip protocol. The key features include:</p><ol><li><strong>Decentralized Architecture</strong>: No central registry server is needed, making the system more resilient.</li><li><strong>Automatic Service Registration</strong>: Services automatically register with the cluster upon startup.</li><li><strong>Health Checking</strong>: The SWIM protocol provides efficient health checking with low overhead.</li><li><strong>Metadata Exchange</strong>: Services exchange metadata with other nodes upon joining the cluster.</li><li><strong>Event-Driven Notifications</strong>: The system is notified when nodes join or leave, ensuring the registry is up-to-date.</li></ol><p>This built-in service registry and discovery component makes go-doudou particularly suitable for containerized environments, edge computing, and scenarios where simple deployment is a priority.</p>`,28);function G(j,H){const l=e("ExternalLinkIcon");return o(),t(r,null,[A,n("p",null,[f,n("a",g,[E,p(l)]),v,F,k,w,N,P,q,M,B]),x,n("p",null,[S,n("a",_,[I,p(l)]),T]),V,n("p",null,[R,n("a",L,[U,p(l)]),W]),z],64)}var J=d(h,[["render",G]]);export{J as default};
