import{r as p,o,a as r,b as n,e,F as t,f as s,g as l}from"./app.2025f35b.js";import{_ as c}from"./plugin-vue_export-helper.21dcd24c.js";const i={},d=n("h1",{id:"how-to-deploy-go-doudou-services-with-pm2-monolithic-edition",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#how-to-deploy-go-doudou-services-with-pm2-monolithic-edition","aria-hidden":"true"},"#"),s(" How to Deploy go-doudou Services with PM2 (Monolithic Edition)")],-1),D=s("In the early stages of my career, I worked as a full-time Node.js full-stack engineer for several years. At that time, PM2 was commonly used to deploy Node.js backend services. PM2 was the most well-known and widely used process management tool in the Node.js ecosystem before Docker became popular. In fact, PM2 can be used for programs written in any programming language, whether they are backend services providing interfaces for frontend engineers, web crawlers, or scheduled background tasks. It can replace tools like "),u=n("code",null,"nohup",-1),m=s(" and "),b=n("code",null,"screen",-1),y=s(" that are more familiar to Linux operations engineers, allowing developers to handle deployments themselves. Two years ago, I published an article on Jianshu about deploying Java services using PM2. The link is here: "),h={href:"https://www.jianshu.com/p/9062ba95f9df",target:"_blank",rel:"noopener noreferrer"},g=s("https://www.jianshu.com/p/9062ba95f9df"),v=s(". Java programmers among the readers may find it useful as a reference. Even in today's era where Docker and Kubernetes are widely popular, I believe PM2 still has significant application value in small and medium-sized enterprises."),f=s("This article will demonstrate the specific usage through a monolithic service "),E=n("code",null,"usersvc",-1),C=s(" developed with the go-doudou microservice framework. I have already published a tutorial on JueJin explaining how to develop this service: "),w={href:"https://juejin.cn/post/7046936284438200333",target:"_blank",rel:"noopener noreferrer"},k=s("Quick Start: Developing Monolithic RESTful Services with go-doudou"),_=s(". Interested readers can read that first and then come back to this article."),x=l(`<h2 id="main-features-of-pm2" tabindex="-1"><a class="header-anchor" href="#main-features-of-pm2" aria-hidden="true">#</a> Main Features of PM2</h2><p>PM2 is a process management tool specifically designed for Node.js applications, with rich functionality. Here I want to summarize the main features that can be used when managing non-Node.js applications with PM2:</p><ul><li>Support for fully automated deployment process initiation and completion after pushing the latest code to a remote repository</li><li>Support for password-free server login through SSH public-private key authentication</li><li>Support for simultaneous deployment to multiple servers</li><li>Support for deploying multiple replicas on a single server (not suitable for public-facing service programs due to port conflict errors)</li><li>Support for configuring multiple sets of environment-specific configurations and specifying which environment to use when starting the program</li><li>Support for configuring various hook functions for convenient execution of custom scripts or commands before and after deployment</li><li>Support for easily viewing the program&#39;s running status, such as restart count, runtime duration, CPU and memory usage, etc.</li><li>Support for easily viewing the program&#39;s basic information, such as startup parameters, log paths, creation time, git commit hash, etc.</li><li>Support for easily viewing program logs, with options to manage logs through plugins like <code>pm2-logrotate</code></li><li>Support for easily configuring startup on system boot</li><li>Support for limiting program memory usage and restarting when the maximum value is reached</li></ul><h2 id="advantages-and-disadvantages-of-pm2-compared-to-docker" tabindex="-1"><a class="header-anchor" href="#advantages-and-disadvantages-of-pm2-compared-to-docker" aria-hidden="true">#</a> Advantages and Disadvantages of PM2 Compared to Docker</h2><p>The following comparison is merely from a software developer&#39;s perspective, based on the goal of deploying programs online and updating them after code modifications. These are some immature experience summaries for readers&#39; reference.</p><h3 id="advantages" tabindex="-1"><a class="header-anchor" href="#advantages" aria-hidden="true">#</a> Advantages</h3><ul><li>Very lightweight with minimal overhead on server resources</li><li>Support for automated deployment relying solely on PM2&#39;s mechanisms</li><li>Support for deploying to multiple servers with a single command</li><li>Easy to learn and developer-friendly</li></ul><h3 id="disadvantages" tabindex="-1"><a class="header-anchor" href="#disadvantages" aria-hidden="true">#</a> Disadvantages</h3><ul><li>Unable to limit CPU usage, with virtually no resource isolation</li><li>Ecosystem obviously not as powerful as Docker&#39;s</li></ul><h2 id="server-preparation" tabindex="-1"><a class="header-anchor" href="#server-preparation" aria-hidden="true">#</a> Server Preparation</h2><p>You need a server with CentOS operating system or install CentOS through a virtual machine on your local computer.</p><h2 id="server-configuration" tabindex="-1"><a class="header-anchor" href="#server-configuration" aria-hidden="true">#</a> Server Configuration</h2><h3 id="installing-go" tabindex="-1"><a class="header-anchor" href="#installing-go" aria-hidden="true">#</a> Installing Go</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;"># Download Go installation package</span></span>
<span class="line"><span style="color:#D4D4D4;">wget https://dl.google.com/go/go1.17.8.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#6A9955;"># Extract</span></span>
<span class="line"><span style="color:#D4D4D4;">tar -zxvf go1.17.8.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#6A9955;"># Move the extracted go folder to /usr/local path</span></span>
<span class="line"><span style="color:#D4D4D4;">mv go /usr/local</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Configure <code>/usr/local/go/bin</code> in the <code>PATH</code> environment variable. You can add the following configuration code to your <code>~/.zshrc</code> or <code>~/.bashrc</code> file:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> PATH=</span><span style="color:#9CDCFE;">$PATH</span><span style="color:#D4D4D4;">:/usr/local/go/bin</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Create a symbolic link (non-root users need to add <code>sudo</code> prefix):</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">ln -s /usr/local/go/bin/go /usr/bin/go
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="installing-pm2" tabindex="-1"><a class="header-anchor" href="#installing-pm2" aria-hidden="true">#</a> Installing PM2</h3><p>First, install Node.js:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">yum update &amp;&amp; yum install -y nodejs</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Then install PM2 (non-root users need to add <code>sudo</code> prefix):</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">npm install -g pm2 --registry=https://registry.npm.taobao.org</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Finally, create symbolic links (non-root users need to add <code>sudo</code> prefix):</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  ~ which node</span></span>
<span class="line"><span style="color:#D4D4D4;">/root/.nvm/versions/node/v14.19.1/bin/node</span></span>
<span class="line"><span style="color:#D4D4D4;">\u279C  ~ ln -s /root/.nvm/versions/node/v14.19.1/bin/node /usr/bin/node</span></span>
<span class="line"><span style="color:#D4D4D4;">\u279C  ~ which pm2</span></span>
<span class="line"><span style="color:#D4D4D4;">/root/.nvm/versions/node/v14.19.1/bin/pm2</span></span>
<span class="line"><span style="color:#D4D4D4;">\u279C  ~ ln -s /root/.nvm/versions/node/v14.19.1/bin/pm2 /usr/bin/pm2</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="installing-mysql" tabindex="-1"><a class="header-anchor" href="#installing-mysql" aria-hidden="true">#</a> Installing MySQL</h3><p>The practical case demonstrated in this article uses MySQL database for data persistence. Readers can choose to skip this section based on their actual needs.</p><p>Add MySQL repository address:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">yum localinstall https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div>`,29),A=s("Find the latest GPG public key from the MySQL official website "),S={href:"https://dev.mysql.com/doc/refman/5.7/en/checking-gpg-signature.html",target:"_blank",rel:"noopener noreferrer"},q=s("https://dev.mysql.com/doc/refman/5.7/en/checking-gpg-signature.html"),M=s(", and use the vi command to copy and paste it into the "),T=n("code",null,"~/mysql5.7_pubkey.asc",-1),L=s(" file:"),N=l(`<div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">vi mysql5.7_pubkey.asc</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Import the public key to MySQL and RPM:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">gpg --import mysql5.7_pubkey.asc</span></span>
<span class="line"><span style="color:#D4D4D4;">rpm --import mysql5.7_pubkey.asc</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Install MySQL 5.7:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">yum install -y mysql-community-server</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>For demonstration purposes, we&#39;ll change the MySQL root user&#39;s password to 1234. In a production environment, never set such a simple password. First, modify the <code>/etc/my.cnf</code> file using the vi command, adding the line <code>validate_password = OFF</code> at the end to disable password rule validation.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">vi /etc/my.cnf</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Then, start the MySQL service instance:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">systemctl start mysqld </span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Check the status of the MySQL service to ensure it has started successfully:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  ~ systemctl status mysqld </span></span>
<span class="line"><span style="color:#D4D4D4;">\u25CF mysqld.service - MySQL Server</span></span>
<span class="line"><span style="color:#D4D4D4;">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#D4D4D4;">   Active: active (running) since Thu 2022-05-05 09:09:41 CST; 33min ago</span></span>
<span class="line"><span style="color:#D4D4D4;">     Docs: man:mysqld(8)</span></span>
<span class="line"><span style="color:#D4D4D4;">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span></span>
<span class="line"><span style="color:#D4D4D4;">  Process: 1156 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid </span><span style="color:#9CDCFE;">$MYSQLD_OPTS</span><span style="color:#D4D4D4;"> (code=exited, status=0/SUCCESS)</span></span>
<span class="line"><span style="color:#D4D4D4;">  Process: 1132 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span></span>
<span class="line"><span style="color:#D4D4D4;"> Main PID: 1159 (mysqld)</span></span>
<span class="line"><span style="color:#D4D4D4;">    Tasks: 28</span></span>
<span class="line"><span style="color:#D4D4D4;">   Memory: 185.1M</span></span>
<span class="line"><span style="color:#D4D4D4;">   CGroup: /system.slice/mysqld.service</span></span>
<span class="line"><span style="color:#D4D4D4;">           \u2514\u25001159 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">May 05 09:09:40 VM-0-17-centos systemd[1]: Starting MySQL Server...</span></span>
<span class="line"><span style="color:#D4D4D4;">May 05 09:09:41 VM-0-17-centos systemd[1]: Started MySQL Server.</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>MySQL initializes a temporary root password during installation. We can find it with the following command:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">grep </span><span style="color:#CE9178;">&#39;password&#39;</span><span style="color:#D4D4D4;"> /var/log/mysqld.log</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>The temporary password is at the end of the first line of log output in the terminal:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  ~ grep </span><span style="color:#CE9178;">&#39;password&#39;</span><span style="color:#D4D4D4;"> /var/log/mysqld.log</span></span>
<span class="line"><span style="color:#D4D4D4;">2022-05-05T00:55:13.552165Z 1 [Note] A temporary password is generated </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> root@localhost: .B&lt;UYdtda3rG</span></span>
<span class="line"><span style="color:#D4D4D4;">2022-05-05T00:55:17.373732Z 0 [Note] Shutting down plugin </span><span style="color:#CE9178;">&#39;validate_password&#39;</span></span>
<span class="line"><span style="color:#D4D4D4;">2022-05-05T00:55:18.983662Z 0 [Note] Shutting down plugin </span><span style="color:#CE9178;">&#39;sha256_password&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>After copying the temporary password, execute the following command:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">mysql_secure_installation</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Following the prompts, change the root password to 1234. For subsequent yes or no input prompts, enter no for all to make no further changes.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">The existing password </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> the user account root has expired. Please </span><span style="color:#DCDCAA;">set</span><span style="color:#D4D4D4;"> a new password.</span></span>
<span class="line"><span style="color:#D4D4D4;">New password:</span></span>
<span class="line"><span style="color:#D4D4D4;">Re-enter new password:</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Test if the password was changed successfully, then create a database named <code>tutorial</code>:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  ~ mysql -uroot -p1234</span></span>
<span class="line"><span style="color:#D4D4D4;">mysql: [Warning] Using a password on the </span><span style="color:#DCDCAA;">command</span><span style="color:#D4D4D4;"> line interface can be insecure.</span></span>
<span class="line"><span style="color:#D4D4D4;">Welcome to the MySQL monitor.  Commands end with ; or </span><span style="color:#D7BA7D;">\\g</span><span style="color:#D4D4D4;">.</span></span>
<span class="line"><span style="color:#D4D4D4;">Your MySQL connection id is 20</span></span>
<span class="line"><span style="color:#D4D4D4;">Server version: 5.7.38 MySQL Community Server (GPL)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Oracle is a registered trademark of Oracle Corporation and/or its</span></span>
<span class="line"><span style="color:#D4D4D4;">affiliates. Other names may be trademarks of their respective</span></span>
<span class="line"><span style="color:#D4D4D4;">owners.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Type </span><span style="color:#CE9178;">&#39;help;&#39;</span><span style="color:#D4D4D4;"> or </span><span style="color:#CE9178;">&#39;\\h&#39;</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> help. Type </span><span style="color:#CE9178;">&#39;\\c&#39;</span><span style="color:#D4D4D4;"> to clear the current input statement.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; CREATE SCHEMA </span><span style="color:#CE9178;">\`tutorial\`</span><span style="color:#D4D4D4;"> DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_general_ci;</span></span>
<span class="line"><span style="color:#D4D4D4;">Query OK, 1 row affected (0.00 sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; </span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Finally, we need to grant the root user remote access permission from any IP. This is for demonstration convenience; it&#39;s not recommended for production environments.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">CREATE USER </span><span style="color:#CE9178;">&#39;root&#39;</span><span style="color:#D4D4D4;">@</span><span style="color:#CE9178;">&#39;%&#39;</span><span style="color:#D4D4D4;"> IDENTIFIED BY </span><span style="color:#CE9178;">&#39;1234&#39;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">GRANT ALL PRIVILEGES ON *.* TO </span><span style="color:#CE9178;">&#39;root&#39;</span><span style="color:#D4D4D4;">@</span><span style="color:#CE9178;">&#39;%&#39;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">FLUSH PRIVILEGES;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>With this, the server configuration work is completed.</p><h2 id="practical-case" tabindex="-1"><a class="header-anchor" href="#practical-case" aria-hidden="true">#</a> Practical Case</h2><p>Below we&#39;ll use a case to explain and demonstrate how to use PM2.</p><h3 id="clone-the-code" tabindex="-1"><a class="header-anchor" href="#clone-the-code" aria-hidden="true">#</a> Clone the Code</h3><p>After cloning the code, please navigate to the <code>usersvc</code> directory.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">git clone git@github.com:unionj-cloud/go-doudou-tutorials.git</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="create-table-structure" tabindex="-1"><a class="header-anchor" href="#create-table-structure" aria-hidden="true">#</a> Create Table Structure</h3><p>Since there are no tables in the <code>tutorial</code> database of the server&#39;s MySQL instance, we need to create the table structure using the <code>go-doudou ddl</code> command. Before executing the command, we need to create a configuration file <code>.env.test.local</code> locally with the following configuration:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;"># Local development needs to connect to the server&#39;s public IP address</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_HOST=162.14.116.92</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_PORT=3306</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_USER=root</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_PASSWD=1234</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>This way, we can directly update the remote MySQL service instance&#39;s table structure by executing go-doudou commands locally. Additionally, we need to add this local configuration file to the <code>.gitignore</code> file to prevent it from being uploaded to the git repository and to prevent the online service from loading this configuration file at startup. Now we can execute the command:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  usersvc git:(master) \u2717 go-doudou ddl --env=test --pre=t_   </span></span>
<span class="line"><span style="color:#D4D4D4;">INFO[2022-05-05 10:11:40] Type: name=User                              </span></span>
<span class="line"><span style="color:#D4D4D4;">CREATE TABLE </span><span style="color:#CE9178;">\`t_user\`</span><span style="color:#D4D4D4;"> (</span></span>
<span class="line"><span style="color:#CE9178;">\`id\`</span><span style="color:#D4D4D4;"> int(11) NOT NULL AUTO_INCREMENT,</span></span>
<span class="line"><span style="color:#CE9178;">\`username\`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;username&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">\`password\`</span><span style="color:#D4D4D4;"> varchar(60) NOT NULL comment </span><span style="color:#CE9178;">&#39;password&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">\`name\`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;real name&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">\`phone\`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;phone number&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">\`dept\`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;department&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">\`avatar\`</span><span style="color:#D4D4D4;"> varchar(255) NOT NULL comment </span><span style="color:#CE9178;">&#39;user avatar&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">\`create_at\`</span><span style="color:#D4D4D4;"> datetime NULL DEFAULT CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color:#CE9178;">\`update_at\`</span><span style="color:#D4D4D4;"> datetime NULL DEFAULT CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color:#CE9178;">\`delete_at\`</span><span style="color:#D4D4D4;"> datetime NULL,</span></span>
<span class="line"><span style="color:#D4D4D4;">PRIMARY KEY (</span><span style="color:#CE9178;">\`id\`</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">UNIQUE INDEX </span><span style="color:#CE9178;">\`username_idx\`</span><span style="color:#D4D4D4;"> (</span><span style="color:#CE9178;">\`username\`</span><span style="color:#D4D4D4;"> asc))</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>You can connect to MySQL to check if the table structure was created successfully:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  usersvc git:(master) \u2717 mysql -h 162.14.116.92 -P 3306 -uroot -p1234</span></span>
<span class="line"><span style="color:#D4D4D4;">mysql: [Warning] Using a password on the </span><span style="color:#DCDCAA;">command</span><span style="color:#D4D4D4;"> line interface can be insecure.</span></span>
<span class="line"><span style="color:#D4D4D4;">Welcome to the MySQL monitor.  Commands end with ; or </span><span style="color:#D7BA7D;">\\g</span><span style="color:#D4D4D4;">.</span></span>
<span class="line"><span style="color:#D4D4D4;">Your MySQL connection id is 22</span></span>
<span class="line"><span style="color:#D4D4D4;">Server version: 5.7.38 MySQL Community Server (GPL)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Oracle is a registered trademark of Oracle Corporation and/or its</span></span>
<span class="line"><span style="color:#D4D4D4;">affiliates. Other names may be trademarks of their respective</span></span>
<span class="line"><span style="color:#D4D4D4;">owners.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Type </span><span style="color:#CE9178;">&#39;help;&#39;</span><span style="color:#D4D4D4;"> or </span><span style="color:#CE9178;">&#39;\\h&#39;</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> help. Type </span><span style="color:#CE9178;">&#39;\\c&#39;</span><span style="color:#D4D4D4;"> to clear the current input statement.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; use tutorial;</span></span>
<span class="line"><span style="color:#D4D4D4;">Reading table information </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> completion of table and column names</span></span>
<span class="line"><span style="color:#D4D4D4;">You can turn off this feature to get a quicker startup with -A</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Database changed</span></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; show tables;</span></span>
<span class="line"><span style="color:#D4D4D4;">+--------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| Tables_in_tutorial |</span></span>
<span class="line"><span style="color:#D4D4D4;">+--------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| t_user             |</span></span>
<span class="line"><span style="color:#D4D4D4;">+--------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">1 row </span><span style="color:#C586C0;">in</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">set</span><span style="color:#D4D4D4;"> (0.00 sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; describe t_user;</span></span>
<span class="line"><span style="color:#D4D4D4;">+-----------+--------------+------+-----+-------------------+-----------------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| Field     | Type         | Null | Key | Default           | Extra                       |</span></span>
<span class="line"><span style="color:#D4D4D4;">+-----------+--------------+------+-----+-------------------+-----------------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| id        | int(11)      | NO   | PRI | NULL              | auto_increment              |</span></span>
<span class="line"><span style="color:#D4D4D4;">| username  | varchar(45)  | NO   | UNI | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| password  | varchar(60)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| name      | varchar(45)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| phone     | varchar(45)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| dept      | varchar(45)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| avatar    | varchar(255) | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| create_at | datetime     | YES  |     | CURRENT_TIMESTAMP |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| update_at | datetime     | YES  |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |</span></span>
<span class="line"><span style="color:#D4D4D4;">| delete_at | datetime     | YES  |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">+-----------+--------------+------+-----+-------------------+-----------------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">10 rows </span><span style="color:#C586C0;">in</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">set</span><span style="color:#D4D4D4;"> (0.02 sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; </span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="pm2-deploy-command" tabindex="-1"><a class="header-anchor" href="#pm2-deploy-command" aria-hidden="true">#</a> PM2 Deploy Command</h3><p>When deploying services, we mainly use PM2&#39;s <code>deploy</code> command. For specific usage, see the instructions in the code block below.</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">&gt; pm2 deploy &lt;config_file&gt; &lt;environment&gt; &lt;command&gt;

  Command list:
    setup                Run remote setup commands
    update               Deploy latest version
    revert [n]           Revert to [n]th last deployment or 1
    curr[ent]            Output current release commit
    prev[ious]           Output previous release commit
    exec|run &lt;cmd&gt;       Execute the given &lt;cmd&gt;
    list                 List previous deploy commits
    [ref]                Deploy to [ref], the &quot;ref&quot; setting, or latest tag
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>In my personal practice, I use the <code>setup</code> and <code>update</code> commands more frequently.</p><h4 id="pm2-initialization" tabindex="-1"><a class="header-anchor" href="#pm2-initialization" aria-hidden="true">#</a> PM2 Initialization</h4><p>Before deploying and updating online services with PM2, we need to execute PM2&#39;s initialization command. The PM2 configuration file <code>ecosystem.config.js</code> is already in the code, which we&#39;ll explain later.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> setup</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>If you see <code>--&gt; Success</code> on the last line of the command line terminal output, it indicates that the initialization was successful.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  usersvc git:(master) pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> setup</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Deploying to </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> environment</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; on host 162.14.116.92</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB hook pre-setup</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB running setup</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB cloning git@github.com:unionj-cloud/go-doudou-tutorials.git</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB full fetch</span></span>
<span class="line"><span style="color:#D4D4D4;">Cloning into </span><span style="color:#CE9178;">&#39;/root/deploy/go-doudou-tutorials/source&#39;</span><span style="color:#D4D4D4;">...</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB hook post-setup</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB setup </span><span style="color:#DCDCAA;">complete</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Success</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="pm2-deployment" tabindex="-1"><a class="header-anchor" href="#pm2-deployment" aria-hidden="true">#</a> PM2 Deployment</h4><p>First, let&#39;s look at the command:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> update</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>If you see <code>--&gt; Success</code> on the last line of the command line terminal output, it indicates that the deployment was successful.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">\u279C  usersvc git:(master) pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> update</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Deploying to </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> environment</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; on host 162.14.116.92</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB deploying origin/master</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB executing pre-deploy-local</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB hook pre-deploy</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB fast forward master</span></span>
<span class="line"><span style="color:#D4D4D4;">Already on </span><span style="color:#CE9178;">&#39;master&#39;</span></span>
<span class="line"><span style="color:#D4D4D4;">From github.com:unionj-cloud/go-doudou-tutorials</span></span>
<span class="line"><span style="color:#D4D4D4;"> * branch            master     -&gt; FETCH_HEAD</span></span>
<span class="line"><span style="color:#D4D4D4;">Already up-to-date.</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB executing post-deploy </span><span style="color:#CE9178;">\`cd usersvc </span><span style="color:#D4D4D4;">&amp;&amp;</span><span style="color:#CE9178;"> sh deploy.sh test\`</span></span>
<span class="line"><span style="color:#D4D4D4;">[PM2][WARN] Applications usersvc not running, starting...</span></span>
<span class="line"><span style="color:#D4D4D4;">[PM2] App [usersvc] launched (1 instances)</span></span>
<span class="line"><span style="color:#D4D4D4;">\u250C\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510</span></span>
<span class="line"><span style="color:#D4D4D4;">\u2502 id  \u2502 name       \u2502 namespace   \u2502 version \u2502 mode    \u2502 pid      \u2502 uptime \u2502 \u21BA    \u2502 status    \u2502 cpu      \u2502 mem      \u2502 user     \u2502 watching \u2502</span></span>
<span class="line"><span style="color:#D4D4D4;">\u251C\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524</span></span>
<span class="line"><span style="color:#D4D4D4;">\u2502 0   \u2502 usersvc    \u2502 default     \u2502 N/A     \u2502 fork    \u2502 10737    \u2502 0s     \u2502 0    \u2502 online    \u2502 0%       \u2502 9.6mb    \u2502 root     \u2502 disabled \u2502</span></span>
<span class="line"><span style="color:#D4D4D4;">\u2514\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB hook </span><span style="color:#DCDCAA;">test</span></span>
<span class="line"><span style="color:#D4D4D4;">  \u25CB successfully deployed origin/master</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Success</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="pm2-deployment-configuration-file" tabindex="-1"><a class="header-anchor" href="#pm2-deployment-configuration-file" aria-hidden="true">#</a> PM2 Deployment Configuration File</h3><p>As mentioned above, the <code>ecosystem.config.js</code> file is the configuration file read by the PM2 deployment command. Let&#39;s take a look at this file; explanations have already been written as comments on the code.</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">// Environment variables configuration needed by the program in different deployment environments</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">ENV</span><span style="color:#D4D4D4;"> = {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// Development environment</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;env_dev&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// GDD_ENV environment variable is equivalent to the spring.profiles.active configuration in the Spring Boot framework of the Java ecosystem</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#CE9178;">&quot;GDD_ENV&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;dev&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">  },</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// Production environment</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;env_prod&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#CE9178;">&quot;GDD_ENV&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;prod&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">  },</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// Test environment</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;env_test&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#CE9178;">&quot;GDD_ENV&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;test&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4EC9B0;">module</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">exports</span><span style="color:#D4D4D4;"> = {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// Multiple applications can be configured in the apps property</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;apps&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> [</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Application name</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;name&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;usersvc&quot;</span><span style="color:#D4D4D4;">,  </span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Startup file, here it&#39;s the binary executable compiled by go build, can be a relative or absolute path</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;script&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./api&quot;</span><span style="color:#D4D4D4;">,  </span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Working directory, since go-doudou-tutorials is a monorepo repository, this configuration is needed,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// the default working directory is /root/deploy/go-doudou-tutorials/current/usersvc</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;cwd&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;/root/deploy/go-doudou-tutorials/current/usersvc&quot;</span><span style="color:#D4D4D4;">,  </span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Runtime environment, default is node for Node.js. Since we&#39;re deploying a binary executable, we don&#39;t need a compiler</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;exec_interpreter&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Running mode, PM2 supports cluster and fork modes.</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// In cluster mode, PM2 can do load balancing, but it only supports Node.js applications,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// so for non-Node.js applications, this can only be configured as fork</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;exec_mode&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;fork&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// JavaScript destructuring syntax, equivalent to embedding the ENV object into this object</span></span>
<span class="line"><span style="color:#D4D4D4;">      ...</span><span style="color:#4FC1FF;">ENV</span></span>
<span class="line"><span style="color:#D4D4D4;">    },</span></span>
<span class="line"><span style="color:#D4D4D4;">  ],</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">deploy:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Test environment deployment configuration, you can configure any number of environments with any name,</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// such as uat, beta, release, production, etc.</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">test:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Multiple IP addresses can be configured for simultaneous deployment to multiple test servers</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">host:</span><span style="color:#D4D4D4;"> [</span><span style="color:#CE9178;">&#39;162.14.116.92&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Server username</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">user:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;root&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// SSH-related configuration</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">ssh_options:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;StrictHostKeyChecking=no&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Code branch to deploy</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">ref:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;origin/master&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Git repository address for the git clone command</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">repo:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;git@github.com:unionj-cloud/go-doudou-tutorials.git&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Server disk path for the code</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">path:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;/root/deploy/go-doudou-tutorials&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// Post-deploy callback command</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// The command configured here means to change to the usersvc directory, then execute the deploy.sh script with the parameter test</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;post-deploy&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;cd usersvc &amp;&amp; sh deploy.sh test&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h3 id="deploy-sh-script" tabindex="-1"><a class="header-anchor" href="#deploy-sh-script" aria-hidden="true">#</a> deploy.sh Script</h3><p>The role of the <code>deploy.sh</code> script is to compile Go code, generate a binary executable file, set the timezone environment variable, and finally execute the <code>pm2 restart</code> command to start or restart the service. Please refer to the comments below to help understand.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># Set environment variables required for compiling the program</span></span>
<span class="line"><span style="color:#6A9955;"># Enable go module</span></span>
<span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> GO111MODULE=on</span></span>
<span class="line"><span style="color:#6A9955;"># Set goproxy to speed up dependency downloads</span></span>
<span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> GOPROXY=https://goproxy.cn,direct</span></span>
<span class="line"><span style="color:#6A9955;"># Compile the program to generate an executable file</span></span>
<span class="line"><span style="color:#D4D4D4;">go build -v -o api cmd/main.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># Since the code in this case uses the standard library time package, where time.Local static variable takes its value from the TZ environment variable,</span></span>
<span class="line"><span style="color:#6A9955;"># if this environment variable is not configured, it defaults to UTC timezone, which usually doesn&#39;t meet our requirements</span></span>
<span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> TZ=</span><span style="color:#CE9178;">&quot;Asia/Shanghai&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># Start the service process through PM2, --only means only deploy the usersvc application, --env means which one of env_dev, env_prod, env_test in the ENV attribute of the configuration file to read, note that the env_ prefix is not added when passing parameters</span></span>
<span class="line"><span style="color:#6A9955;"># The pm2 restart command is executed on the server, which is fundamentally different from the pm2 deploy command</span></span>
<span class="line"><span style="color:#D4D4D4;">pm2 restart ecosystem.config.js --only usersvc --env </span><span style="color:#9CDCFE;">$1</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion" aria-hidden="true">#</a> Conclusion</h2><p>In this article, we first introduced the main features of the PM2 process management tool and its advantages and disadvantages compared to Docker. Then we described the preliminary work needed to prepare the server for deploying applications written in Go. Finally, we demonstrated the deployment process through a practical case and explained the PM2-related configuration files and deployment scripts. I believe that all Gophers have now mastered the method of deploying go-doudou services using PM2. In the next article, I will demonstrate how to use PM2 to deploy microservices using a case involving a service written with the Spring Boot framework from the Java ecosystem and a service written with go-doudou.</p><h2 id="reference-links" tabindex="-1"><a class="header-anchor" href="#reference-links" aria-hidden="true">#</a> Reference Links</h2>`,59),P=s("PM2 official configuration file documentation: "),F={href:"https://pm2.keymetrics.io/docs/usage/application-declaration/",target:"_blank",rel:"noopener noreferrer"},I=s("https://pm2.keymetrics.io/docs/usage/application-declaration/"),U=s("PM2 official deployment documentation: "),O={href:"https://pm2.keymetrics.io/docs/usage/deployment/",target:"_blank",rel:"noopener noreferrer"},R=s("https://pm2.keymetrics.io/docs/usage/deployment/");function j(Q,G){const a=p("ExternalLinkIcon");return o(),r(t,null,[d,n("p",null,[D,u,m,b,y,n("a",h,[g,e(a)]),v]),n("p",null,[f,E,C,n("a",w,[k,e(a)]),_]),x,n("p",null,[A,n("a",S,[q,e(a)]),M,T,L]),N,n("ul",null,[n("li",null,[P,n("a",F,[I,e(a)])]),n("li",null,[U,n("a",O,[R,e(a)])])])],64)}var z=c(i,[["render",j]]);export{z as default};
