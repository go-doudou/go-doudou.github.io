<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.35">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/x-icon" sizes="32x32" href="/favicon.ico"><script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?658d535852e4dcdd8f3934c1c3e87165";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script><meta name="keywords" content="go-doudou,Go语言微服务框架,golang,go-doudou微服务框架,RESTful,微服务,服务注册与发现,负载均衡,熔断限流,grpc,去中心化,golang microservice framework,golang orm,ORM工具,microservice,service discovery,load balancing,circuit breaker,rate limit,低代码平台"><meta name="description" content="go-doudou是一个go语言微服务框架。它同时支持开发单体应用。从定义Go语言接口开始，无须学习任何接口描述语言。内置基于SWIM gossip协议的服务注册与发现的机制，帮助你构建一个健壮的、可扩展的、去中心化的微服务集群。内置强大的代码生成器。"><title>go-doudou + langchaingo 微内核架构RAG大模型知识库实战（一） | go-doudou</title>
    <link rel="modulepreload" href="/assets/app.2025f35b.js"><link rel="modulepreload" href="/assets/plugin-mechanism.html.15d8151b.js"><link rel="modulepreload" href="/assets/plugin-mechanism.html.5319a8ce.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/assets/style.993d40d8.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/zh/" class=""><img class="logo" src="/logo.png" alt="go-doudou"><span class="site-name can-hide">go-doudou</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/zh/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/resources/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/blog/" class="router-link-active" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/contribution/" class="" aria-label="贡献"><!--[--><!--]--> 贡献 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou/releases" rel="noopener noreferrer" target="_blank" aria-label="Release Notes"><!--[--><!--]--> Release Notes <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/plugin-mechanism.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/zh/blog/plugin-mechanism.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/zh/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/resources/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/blog/" class="router-link-active" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/contribution/" class="" aria-label="贡献"><!--[--><!--]--> 贡献 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou/releases" rel="noopener noreferrer" target="_blank" aria-label="Release Notes"><!--[--><!--]--> Release Notes <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/plugin-mechanism.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/zh/blog/plugin-mechanism.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">go-doudou + langchaingo 微内核架构RAG大模型知识库实战（一） <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_1-什么是插件机制和微内核架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="1. 什么是插件机制和微内核架构"><!--[--><!--]--> 1. 什么是插件机制和微内核架构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_2-go-doudou框架的插件机制" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. go-doudou框架的插件机制"><!--[--><!--]--> 2. go-doudou框架的插件机制 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_3-插件的实现与注册" class="router-link-active router-link-exact-active sidebar-item" aria-label="3. 插件的实现与注册"><!--[--><!--]--> 3. 插件的实现与注册 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_4-模块间的通信" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. 模块间的通信"><!--[--><!--]--> 4. 模块间的通信 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_5-模块化设计的实践" class="router-link-active router-link-exact-active sidebar-item" aria-label="5. 模块化设计的实践"><!--[--><!--]--> 5. 模块化设计的实践 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_6-实战案例-rag聊天系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="6. 实战案例：RAG聊天系统"><!--[--><!--]--> 6. 实战案例：RAG聊天系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_7-系统启动与使用示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="7. 系统启动与使用示例"><!--[--><!--]--> 7. 系统启动与使用示例 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_7-1-启动系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.1 启动系统"><!--[--><!--]--> 7.1 启动系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_7-2-调用示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.2 调用示例"><!--[--><!--]--> 7.2 调用示例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_7-3-知识库检索失败的处理机制" class="router-link-active router-link-exact-active sidebar-item" aria-label="7.3 知识库检索失败的处理机制"><!--[--><!--]--> 7.3 知识库检索失败的处理机制 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#_8-总结与展望" class="router-link-active router-link-exact-active sidebar-item" aria-label="8. 总结与展望"><!--[--><!--]--> 8. 总结与展望 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/plugin-mechanism.html#参考资料" class="router-link-active router-link-exact-active sidebar-item" aria-label="参考资料"><!--[--><!--]--> 参考资料 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="go-doudou-langchaingo-微内核架构rag大模型知识库实战-一" tabindex="-1"><a class="header-anchor" href="#go-doudou-langchaingo-微内核架构rag大模型知识库实战-一" aria-hidden="true">#</a> go-doudou + langchaingo 微内核架构RAG大模型知识库实战（一）</h1><p><img src="/assets/go-doudou_langchaingo.94532c93.png" alt="programming.jpg"> Photo by <a href="https://unsplash.com/@cgower?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Christopher Gower</a> on <a href="https://unsplash.com/photos/a-macbook-with-lines-of-code-on-its-screen-on-a-busy-desk-m_HRfLhgABo?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Unsplash</a></p><p>在现代微服务架构设计中，模块化和可插拔的设计模式越来越受到开发者的青睐。go-doudou作为一款国产的Go语言微服务框架，提供了优秀的插件机制和模块化架构支持。本文将通过一个基于RAG（检索增强生成）的实际项目来详细讲解go-doudou的插件机制和模块化微内核架构的实现方式。</p><h2 id="_1-什么是插件机制和微内核架构" tabindex="-1"><a class="header-anchor" href="#_1-什么是插件机制和微内核架构" aria-hidden="true">#</a> 1. 什么是插件机制和微内核架构</h2><p>微内核架构（MicroKernel Architecture）也称为插件架构（Plugin Architecture），是一种将核心系统功能与扩展功能分离的设计模式。在这种架构中：</p><ul><li><strong>核心系统</strong>：提供基础服务和管理插件的机制</li><li><strong>插件模块</strong>：独立开发、独立部署，实现特定功能</li></ul><p>这种架构的优势在于：</p><ol><li><strong>高度模块化</strong>：每个插件都是独立的功能单元</li><li><strong>可扩展性强</strong>：可以无需修改核心系统来添加新功能</li><li><strong>低耦合</strong>：各模块之间通过定义良好的接口通信</li><li><strong>灵活部署</strong>：可以按需加载插件</li></ol><h2 id="_2-go-doudou框架的插件机制" tabindex="-1"><a class="header-anchor" href="#_2-go-doudou框架的插件机制" aria-hidden="true">#</a> 2. go-doudou框架的插件机制</h2><p>go-doudou框架通过实现<code>ServicePlugin</code>接口来支持插件机制。每个服务模块作为一个插件被注册到主应用中，实现了模块与核心系统的解耦。</p><p>让我们先看一下该项目中<code>main/cmd/main.go</code>的核心代码：</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">package</span><span style="color:#D4D4D4;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">import</span><span style="color:#D4D4D4;"> (</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;go-doudou-rag/toolkit/auth&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/go-doudou/v2/framework/grpcx&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/go-doudou/v2/framework/plugin&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/go-doudou/v2/framework/rest&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/toolkit/pipeconn&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/toolkit/zlogger&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;google.golang.org/grpc&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	_ </span><span style="color:#CE9178;">&quot;go-doudou-rag/module-auth/plugin&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	_ </span><span style="color:#CE9178;">&quot;go-doudou-rag/module-chat/plugin&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	_ </span><span style="color:#CE9178;">&quot;go-doudou-rag/module-knowledge/plugin&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := rest.</span><span style="color:#DCDCAA;">NewRestServer</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Use</span><span style="color:#D4D4D4;">(auth.Jwt)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">grpcServer</span><span style="color:#D4D4D4;"> := grpcx.</span><span style="color:#DCDCAA;">NewGrpcServer</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// GRPC配置...</span></span>
<span class="line"><span style="color:#D4D4D4;">	)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">lis</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">dialCtx</span><span style="color:#D4D4D4;"> := pipeconn.</span><span style="color:#DCDCAA;">NewPipeListener</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">plugins</span><span style="color:#D4D4D4;"> := plugin.</span><span style="color:#DCDCAA;">GetServicePlugins</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> := </span><span style="color:#C586C0;">range</span><span style="color:#D4D4D4;"> plugins.</span><span style="color:#DCDCAA;">Keys</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">value</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> := plugins.</span><span style="color:#DCDCAA;">Get</span><span style="color:#D4D4D4;">(key)</span></span>
<span class="line"><span style="color:#D4D4D4;">		value.</span><span style="color:#DCDCAA;">Initialize</span><span style="color:#D4D4D4;">(srv, grpcServer, dialCtx)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">r</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">recover</span><span style="color:#D4D4D4;">(); r != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			zlogger.</span><span style="color:#DCDCAA;">Info</span><span style="color:#D4D4D4;">().</span><span style="color:#DCDCAA;">Msgf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Recovered. Error: </span><span style="color:#9CDCFE;">%v</span><span style="color:#D7BA7D;">\n</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, r)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">key</span><span style="color:#D4D4D4;"> := </span><span style="color:#C586C0;">range</span><span style="color:#D4D4D4;"> plugins.</span><span style="color:#DCDCAA;">Keys</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">value</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> := plugins.</span><span style="color:#DCDCAA;">Get</span><span style="color:#D4D4D4;">(key)</span></span>
<span class="line"><span style="color:#D4D4D4;">			value.</span><span style="color:#DCDCAA;">Close</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">		grpcServer.</span><span style="color:#DCDCAA;">RunWithPipe</span><span style="color:#D4D4D4;">(lis)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoutes</span><span style="color:#D4D4D4;">(rest.</span><span style="color:#DCDCAA;">DocRoutes</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;&quot;</span><span style="color:#D4D4D4;">))</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>这段代码展示了go-doudou的微内核架构实现：</p><ol><li>通过匿名导入(<code>_ &quot;go-doudou-rag/module-xxx/plugin&quot;</code>)各模块的plugin包</li><li>获取所有注册的服务插件 <code>plugin.GetServicePlugins()</code></li><li>调用每个插件的<code>Initialize</code>方法，将REST服务器和gRPC服务器传入</li><li>注册资源清理函数，确保在程序退出时调用插件的<code>Close</code>方法</li></ol><h2 id="_3-插件的实现与注册" tabindex="-1"><a class="header-anchor" href="#_3-插件的实现与注册" aria-hidden="true">#</a> 3. 插件的实现与注册</h2><p>每个模块通过实现<code>ServicePlugin</code>接口来成为一个插件。以<code>module-auth</code>模块为例：</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">package</span><span style="color:#D4D4D4;"> plugin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">import</span><span style="color:#D4D4D4;"> (</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/glebarez/sqlite&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/go-doudou/v2/framework/grpcx&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/go-doudou/v2/framework/plugin&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/go-doudou/v2/framework/rest&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/toolkit/pipeconn&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;github.com/unionj-cloud/toolkit/stringutils&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	service </span><span style="color:#CE9178;">&quot;go-doudou-rag/module-auth&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;go-doudou-rag/module-auth/config&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;go-doudou-rag/module-auth/internal/dao&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;go-doudou-rag/module-auth/internal/model&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;go-doudou-rag/module-auth/transport/httpsrv&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;google.golang.org/grpc&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;gorm.io/gorm&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#CE9178;">&quot;os&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> plugin.ServicePlugin = (*ModuleAuthPlugin)(</span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">type</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">ModuleAuthPlugin</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">	grpcConns []*grpc.ClientConn</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (receiver *ModuleAuthPlugin) </span><span style="color:#DCDCAA;">Close</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">item</span><span style="color:#D4D4D4;"> := </span><span style="color:#C586C0;">range</span><span style="color:#D4D4D4;"> receiver.grpcConns {</span></span>
<span class="line"><span style="color:#D4D4D4;">		item.</span><span style="color:#DCDCAA;">Close</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (receiver *ModuleAuthPlugin) </span><span style="color:#DCDCAA;">GoDoudouServicePlugin</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (receiver *ModuleAuthPlugin) </span><span style="color:#DCDCAA;">GetName</span><span style="color:#D4D4D4;">() </span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">name</span><span style="color:#D4D4D4;"> := os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;GDD_SERVICE_NAME&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> stringutils.</span><span style="color:#DCDCAA;">IsEmpty</span><span style="color:#D4D4D4;">(name) {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">name</span><span style="color:#D4D4D4;"> = </span><span style="color:#CE9178;">&quot;cloud.unionj.ModuleAuth&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> name</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (receiver *ModuleAuthPlugin) </span><span style="color:#DCDCAA;">Initialize</span><span style="color:#D4D4D4;">(restServer *rest.RestServer, grpcServer *grpcx.GrpcServer, dialCtx pipeconn.DialContextFunc) {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := gorm.</span><span style="color:#DCDCAA;">Open</span><span style="color:#D4D4D4;">(sqlite.</span><span style="color:#DCDCAA;">Open</span><span style="color:#D4D4D4;">(conf.Db.Dsn), &amp;gorm.Config{})</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#DCDCAA;">panic</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;failed to connect database&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = db.</span><span style="color:#DCDCAA;">AutoMigrate</span><span style="color:#D4D4D4;">(&amp;model.User{}); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#DCDCAA;">panic</span><span style="color:#D4D4D4;">(err)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	dao.</span><span style="color:#DCDCAA;">Use</span><span style="color:#D4D4D4;">(db)</span></span>
<span class="line"><span style="color:#D4D4D4;">	dao.</span><span style="color:#DCDCAA;">Init</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewModuleAuth</span><span style="color:#D4D4D4;">(conf)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">routes</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">NewModuleAuthHandler</span><span style="color:#D4D4D4;">(svc))</span></span>
<span class="line"><span style="color:#D4D4D4;">	restServer.</span><span style="color:#DCDCAA;">GroupRoutes</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;/moduleauth&quot;</span><span style="color:#D4D4D4;">, routes)</span></span>
<span class="line"><span style="color:#D4D4D4;">	restServer.</span><span style="color:#DCDCAA;">GroupRoutes</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;/moduleauth&quot;</span><span style="color:#D4D4D4;">, rest.</span><span style="color:#DCDCAA;">DocRoutes</span><span style="color:#D4D4D4;">(service.Oas))</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">init</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	plugin.</span><span style="color:#DCDCAA;">RegisterServicePlugin</span><span style="color:#D4D4D4;">(&amp;ModuleAuthPlugin{})</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>这个插件实现了关键的接口方法：</p><ul><li><code>GoDoudouServicePlugin()</code>: 标识接口方法</li><li><code>GetName()</code>: 返回插件名称</li><li><code>Initialize()</code>: 初始化插件，注册HTTP路由</li><li><code>Close()</code>: 释放资源</li></ul><p>特别注意<code>init()</code>函数中的<code>plugin.RegisterServicePlugin()</code>，它将插件注册到全局插件注册表中，使得主应用能够发现并加载这个插件。</p><h2 id="_4-模块间的通信" tabindex="-1"><a class="header-anchor" href="#_4-模块间的通信" aria-hidden="true">#</a> 4. 模块间的通信</h2><p>在微内核架构中，模块间通信是关键挑战之一。go-doudou提供了多种通信方式：</p><ol><li><strong>直接依赖调用</strong>：模块可以直接导入其他模块的接口</li><li><strong>依赖注入</strong>：通过<code>samber/do</code>库实现依赖注入</li></ol><p>在<code>module-chat</code>的实现中，我们可以看到如何调用<code>module-knowledge</code>的服务：</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (receiver *ModuleChatImpl) </span><span style="color:#DCDCAA;">Chat</span><span style="color:#D4D4D4;">(ctx context.Context, req dto.ChatRequest) (err </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// ...省略部分代码...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">knowService</span><span style="color:#D4D4D4;"> := do.MustInvoke[know.ModuleKnowledge](</span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">queryResults</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := knowService.</span><span style="color:#DCDCAA;">GetQuery</span><span style="color:#D4D4D4;">(ctx, kdto.QueryReq{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Text: req.Prompt,</span></span>
<span class="line"><span style="color:#D4D4D4;">		Top:  </span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// ...省略部分代码...</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>module-knowledge</code>通过依赖注入注册服务：</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">init</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">	plugin.</span><span style="color:#DCDCAA;">RegisterServicePlugin</span><span style="color:#D4D4D4;">(&amp;ModuleKnowledgePlugin{})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	do.Provide[service.ModuleKnowledge](</span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(injector *do.Injector) (service.ModuleKnowledge, </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">db</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := gorm.</span><span style="color:#DCDCAA;">Open</span><span style="color:#D4D4D4;">(sqlite.</span><span style="color:#DCDCAA;">Open</span><span style="color:#D4D4D4;">(conf.Db.Dsn), &amp;gorm.Config{})</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#DCDCAA;">panic</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;failed to connect database&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = db.</span><span style="color:#DCDCAA;">AutoMigrate</span><span style="color:#D4D4D4;">(&amp;model.File{}); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#DCDCAA;">panic</span><span style="color:#D4D4D4;">(err)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		dao.</span><span style="color:#DCDCAA;">Use</span><span style="color:#D4D4D4;">(db)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewModuleKnowledge</span><span style="color:#D4D4D4;">(conf)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> svc, </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="_5-模块化设计的实践" tabindex="-1"><a class="header-anchor" href="#_5-模块化设计的实践" aria-hidden="true">#</a> 5. 模块化设计的实践</h2><p>该项目展示了模块化设计的最佳实践，每个模块有清晰的职责划分：</p><ol><li><strong>Module-Auth</strong>: 负责用户认证</li><li><strong>Module-Chat</strong>: 实现聊天功能，集成大语言模型</li><li><strong>Module-Knowledge</strong>: 知识库管理，实现RAG检索</li></ol><p>每个模块都遵循相似的内部结构：</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">module-xxx/
  ├── cmd/              # 独立运行入口
  ├── config/           # 模块配置
  ├── dto/              # 数据传输对象
  ├── internal/         # 内部实现
  │   ├── dao/          # 数据访问
  │   └── model/        # 数据模型
  ├── plugin/           # 插件实现
  ├── transport/        # 传输层
  │   └── httpsrv/      # HTTP服务
  ├── svc.go            # 服务接口定义
  └── svcimpl.go        # 服务实现
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这种结构保证了：</p><ol><li>接口与实现分离</li><li>关注点分离</li><li>清晰的依赖关系</li><li>良好的封装性</li></ol><h2 id="_6-实战案例-rag聊天系统" tabindex="-1"><a class="header-anchor" href="#_6-实战案例-rag聊天系统" aria-hidden="true">#</a> 6. 实战案例：RAG聊天系统</h2><p>这个项目实现了一个基于RAG（检索增强生成）的聊天系统，整体流程如下：</p><ol><li>用户通过<code>module-auth</code>进行认证</li><li>认证后可以通过<code>module-knowledge</code>上传知识文档</li><li>用户通过<code>module-chat</code>提问，系统会： <ul><li>从<code>module-knowledge</code>检索相关内容</li><li>调用大语言模型生成答案</li><li>使用SSE（Server-Sent Events）流式返回结果</li></ul></li></ol><p>例如，<code>module-chat</code>中的核心处理逻辑：</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (receiver *ModuleChatImpl) </span><span style="color:#DCDCAA;">Chat</span><span style="color:#D4D4D4;">(ctx context.Context, req dto.ChatRequest) (err </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// ...设置响应头...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 创建LLM客户端</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">llm</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := openai.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">		openai.</span><span style="color:#DCDCAA;">WithBaseURL</span><span style="color:#D4D4D4;">(receiver.conf.Openai.BaseUrl),</span></span>
<span class="line"><span style="color:#D4D4D4;">		openai.</span><span style="color:#DCDCAA;">WithToken</span><span style="color:#D4D4D4;">(lo.</span><span style="color:#DCDCAA;">Ternary</span><span style="color:#D4D4D4;">(stringutils.</span><span style="color:#DCDCAA;">IsNotEmpty</span><span style="color:#D4D4D4;">(receiver.conf.Openai.Token), </span></span>
<span class="line"><span style="color:#D4D4D4;">			receiver.conf.Openai.Token, os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;OPENAI_API_KEY&quot;</span><span style="color:#D4D4D4;">))),</span></span>
<span class="line"><span style="color:#D4D4D4;">		openai.</span><span style="color:#DCDCAA;">WithEmbeddingModel</span><span style="color:#D4D4D4;">(receiver.conf.Openai.EmbeddingModel),</span></span>
<span class="line"><span style="color:#D4D4D4;">		openai.</span><span style="color:#DCDCAA;">WithModel</span><span style="color:#D4D4D4;">(receiver.conf.Openai.Model),</span></span>
<span class="line"><span style="color:#D4D4D4;">	)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 从知识库检索相关内容</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">knowService</span><span style="color:#D4D4D4;"> := do.MustInvoke[know.ModuleKnowledge](</span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">queryResults</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := knowService.</span><span style="color:#DCDCAA;">GetQuery</span><span style="color:#D4D4D4;">(ctx, kdto.QueryReq{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Text: req.Prompt,</span></span>
<span class="line"><span style="color:#D4D4D4;">		Top:  </span><span style="color:#B5CEA8;">10</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 过滤相关性高的结果</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">queryResults</span><span style="color:#D4D4D4;"> = lo.</span><span style="color:#DCDCAA;">Filter</span><span style="color:#D4D4D4;">(queryResults, </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(item kdto.QueryResult, index </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;">) </span><span style="color:#4EC9B0;">bool</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> cast.</span><span style="color:#DCDCAA;">ToFloat64</span><span style="color:#D4D4D4;">(item.Similarity) &gt;= </span><span style="color:#B5CEA8;">0.5</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 构建提示词</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">prompt</span><span style="color:#D4D4D4;"> := </span><span style="color:#CE9178;">&quot;请结合下面给出的上下文信息回答问题...&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 调用LLM生成回答并流式返回</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">content</span><span style="color:#D4D4D4;"> := []llms.MessageContent{</span></span>
<span class="line"><span style="color:#D4D4D4;">		llms.</span><span style="color:#DCDCAA;">TextParts</span><span style="color:#D4D4D4;">(llms.ChatMessageTypeSystem, </span><span style="color:#CE9178;">&quot;You are a senior public policy researcher.&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		llms.</span><span style="color:#DCDCAA;">TextParts</span><span style="color:#D4D4D4;">(llms.ChatMessageTypeHuman, prompt),</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = llm.</span><span style="color:#DCDCAA;">GenerateContent</span><span style="color:#D4D4D4;">(ctx, content,</span></span>
<span class="line"><span style="color:#D4D4D4;">		llms.</span><span style="color:#DCDCAA;">WithMaxTokens</span><span style="color:#D4D4D4;">(</span><span style="color:#B5CEA8;">4096</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		llms.</span><span style="color:#DCDCAA;">WithTemperature</span><span style="color:#D4D4D4;">(</span><span style="color:#B5CEA8;">0.2</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		llms.</span><span style="color:#DCDCAA;">WithStreamingFunc</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(ctx context.Context, chunk []</span><span style="color:#4EC9B0;">byte</span><span style="color:#D4D4D4;">) </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">chunkResp</span><span style="color:#D4D4D4;"> := dto.ChatResponse{</span></span>
<span class="line"><span style="color:#D4D4D4;">				Content:   </span><span style="color:#DCDCAA;">string</span><span style="color:#D4D4D4;">(chunk),</span></span>
<span class="line"><span style="color:#D4D4D4;">				RequestID: requestID,</span></span>
<span class="line"><span style="color:#D4D4D4;">				Type:      </span><span style="color:#CE9178;">&quot;content&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">writeSSEMessage</span><span style="color:#D4D4D4;">(w, flusher, chunkResp)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}))</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h2 id="_7-系统启动与使用示例" tabindex="-1"><a class="header-anchor" href="#_7-系统启动与使用示例" aria-hidden="true">#</a> 7. 系统启动与使用示例</h2><h3 id="_7-1-启动系统" tabindex="-1"><a class="header-anchor" href="#_7-1-启动系统" aria-hidden="true">#</a> 7.1 启动系统</h3><p>通过以下步骤启动此基于go-doudou插件架构的RAG系统：</p><ol><li><p><strong>克隆代码库并进入项目目录</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">git clone https://github.com/your-repo/go-doudou-rag.git</span></span>
<span class="line"><span style="color:#DCDCAA;">cd</span><span style="color:#D4D4D4;"> go-doudou-rag</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p><strong>安装依赖</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">go mod tidy</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p><strong>启动主应用</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#DCDCAA;">cd</span><span style="color:#D4D4D4;"> main/cmd</span></span>
<span class="line"><span style="color:#D4D4D4;">go run main.go</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol><p>系统启动后，所有模块（auth、chat、knowledge）会作为插件被加载，各自的API端点也会被注册到主应用中。</p><h3 id="_7-2-调用示例" tabindex="-1"><a class="header-anchor" href="#_7-2-调用示例" aria-hidden="true">#</a> 7.2 调用示例</h3><p>下面展示如何使用curl命令向聊天服务发送请求，实现基于知识库的问答：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;"># 登录</span></span>
<span class="line"><span style="color:#D4D4D4;">curl --location </span><span style="color:#CE9178;">&#39;http://localhost:6060/moduleauth/login&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--header </span><span style="color:#CE9178;">&#39;Content-Type: application/json&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--data </span><span style="color:#CE9178;">&#39;{</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;username&quot;: &quot;admin&quot;,</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;password&quot;: &quot;admin&quot;</span></span>
<span class="line"><span style="color:#CE9178;">}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 上传pdf文档</span></span>
<span class="line"><span style="color:#D4D4D4;">curl --location </span><span style="color:#CE9178;">&#39;http://localhost:6060/moduleknowledge/upload&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--header </span><span style="color:#CE9178;">&#39;Authorization: Bearer &lt;从登录接口获取的token&gt;&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--form </span><span style="color:#CE9178;">&#39;file=@&quot;/Users/wubin1989/Downloads/杭州市人民政府印发关于进一步推动经济高质量发展若干政策的通知.pdf&quot;&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 聊天</span></span>
<span class="line"><span style="color:#D4D4D4;">curl -w </span><span style="color:#CE9178;">&#39;\n&#39;</span><span style="color:#D4D4D4;"> -N -X POST </span><span style="color:#CE9178;">&#39;http://localhost:6060/modulechat/chat&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--header </span><span style="color:#CE9178;">&#39;Content-Type: application/json&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--header </span><span style="color:#CE9178;">&#39;Authorization: Bearer &lt;从登录接口获取的token&gt;&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--data </span><span style="color:#CE9178;">&#39;{</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;prompt&quot;: &quot;最近杭州出台了什么经济相关的政策？&quot;</span></span>
<span class="line"><span style="color:#CE9178;">}&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>系统响应示例：</p><p>首先，系统会返回构建的提示词（包含从知识库检索到的上下文信息）：</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">请结合下面给出的上下文信息回答问题，答案必须分条阐述，力求条理清晰，如果不知道可以回答不知道，但不要编造答案：
1. — 1 —
杭州市人民政府文件
杭政函〔2024〕16 号
杭州市人民政府印发关于进一步推动
经济高质量发展若干政策的通知
各区、县（市）人民政府，市政府各部门、各直属单位：
现将《关于进一步推动经济高质量发展的若干政策》印发给
你们，请结合实际认真组织实施。
杭州市人民政府
2024 年 2 月 18 日
（此件公开发布）
ZJAC00-2024-0001
2. — 2 —
关于进一步推动经济高质量发展的若干政策
... [省略部分上下文] ...
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>然后，系统会基于检索到的上下文信息，生成结构化的回答：</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">根据提供的信息，杭州市人民政府最近出台了一系列推动经济高质量发展的政策，具体包括以下几个方面：

1. **扩大有效投资政策**：推动《杭州市政府投资项目管理条例》出台，落实省扩大有效投资&quot;千项万亿&quot;工程，2024年计划完成投资800亿元以上，带动固定资产投资增长3%。

2. **激发消费潜能**：落实新能源汽车减免购置税等政策，全年新增公共领域充电设施3000个，组织促消费活动500场以上，举办餐饮促消费活动50场以上。

3. **支持企业高质量发展**：完善优质企业梯度培育机制，对首次上规纳统的工业企业给予最高20万元的一次性奖励，上规后连续3年保持在规的再给予不超过30万元的一次性奖励。

4. **稳定外贸发展**：全年组织不少于150个外贸团组，参加100个以上境外展会，3000家次企业赴境外拓市场，提高企业短期出口信用保险的投保费资助比例上限至60%（制造业企业上限提高至65%）。

5. **打造国际会展之都**：高质量办好第三届全球数字贸易博览会，实现五个翻番，2024年招引30场展览落户杭州国博中心和大会展中心。

6. **支持数字贸易发展**：鼓励企业开展数据出境安全评估，参与制定数字贸易领域各类标准，持续推动服务贸易创新发展。

7. **发挥电商优势**：推进杭州市新电商高质量发展，全年累计打造电商直播式&quot;共富工坊&quot;不少于200家，深化杭州跨境电商综试区建设。

8. **强化财政资金支持**：市财政2024年预算安排6亿元，用于支持扩大内需促消费领域，支持外贸发展、新电商高质量发展、跨境电商发展、新开国际航线等。
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_7-3-知识库检索失败的处理机制" tabindex="-1"><a class="header-anchor" href="#_7-3-知识库检索失败的处理机制" aria-hidden="true">#</a> 7.3 知识库检索失败的处理机制</h3><p>RAG系统的一个重要特性是仅回答基于知识库中存在的信息，当用户提问的内容与知识库中的文档相关性不高或完全不相关时，系统会明确告知用户无法回答，而不是生成可能不准确的信息。以下是一个示例：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">curl -w </span><span style="color:#CE9178;">&#39;\n&#39;</span><span style="color:#D4D4D4;"> -N -X POST </span><span style="color:#CE9178;">&#39;http://localhost:6060/modulechat/chat&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--header </span><span style="color:#CE9178;">&#39;Content-Type: application/json&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--header </span><span style="color:#CE9178;">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3NDU4OTM4MTMsInVzZXJuYW1lIjoiYWRtaW4ifQ.EjxDfrMMHmOCvt557H8rd5sn9zX-uYOytw4OKH-jLJ8&#39;</span><span style="color:#D4D4D4;"> \</span></span>
<span class="line"><span style="color:#D4D4D4;">--data </span><span style="color:#CE9178;">&#39;{</span></span>
<span class="line"><span style="color:#CE9178;">    &quot;prompt&quot;: &quot;Java的最新版本是哪个？&quot;            </span></span>
<span class="line"><span style="color:#CE9178;">}&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>系统响应：</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">非常抱歉，未能检索到相关信息，无法回答
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>在代码实现中，这个机制通过以下方式实现：</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">// 从module-chat/svcimpl.go中的实现</span></span>
<span class="line"><span style="color:#9CDCFE;">queryResults</span><span style="color:#D4D4D4;"> = lo.</span><span style="color:#DCDCAA;">Filter</span><span style="color:#D4D4D4;">(queryResults, </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(item kdto.QueryResult, index </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;">) </span><span style="color:#4EC9B0;">bool</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> cast.</span><span style="color:#DCDCAA;">ToFloat64</span><span style="color:#D4D4D4;">(item.Similarity) &gt;= </span><span style="color:#B5CEA8;">0.5</span></span>
<span class="line"><span style="color:#D4D4D4;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(queryResults) == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    zlogger.</span><span style="color:#DCDCAA;">Error</span><span style="color:#D4D4D4;">().</span><span style="color:#DCDCAA;">Msgf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Knowledge not found, requestId: </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, requestID)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">chunk</span><span style="color:#D4D4D4;"> := dto.ChatResponse{</span></span>
<span class="line"><span style="color:#D4D4D4;">        Content:   </span><span style="color:#CE9178;">&quot;非常抱歉，未能检索到相关信息，无法回答&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">        RequestID: requestID,</span></span>
<span class="line"><span style="color:#D4D4D4;">        Type:      </span><span style="color:#CE9178;">&quot;error&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#DCDCAA;">writeSSEMessage</span><span style="color:#D4D4D4;">(w, flusher, chunk)</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这个设计确保了系统只回答它有知识基础的问题，提高了回答的可靠性和准确性，避免了生成虚假信息的风险。它是负责任的AI应用设计的一个重要方面，尤其在需要高度准确性的领域如政策咨询、法律建议等方面尤为重要。</p><p>这个示例充分展示了插件架构的强大之处：</p><ol><li><strong>模块协作</strong>：<code>module-auth</code>处理认证，<code>module-knowledge</code>负责知识检索，<code>module-chat</code>集成大语言模型生成回答</li><li><strong>可插拔性</strong>：各模块可独立更新或替换</li><li><strong>技术解耦</strong>：每个模块可以使用不同的技术栈和数据存储方式</li></ol><h2 id="_8-总结与展望" tabindex="-1"><a class="header-anchor" href="#_8-总结与展望" aria-hidden="true">#</a> 8. 总结与展望</h2><p>本文通过一个实际的RAG聊天系统案例，详细介绍了go-doudou框架中的插件机制与模块化可插拔微内核架构。我们看到，这种架构模式不仅提供了良好的模块化和可扩展性，还使得系统各部分能够松耦合地协同工作，大大提高了开发效率和系统可维护性。</p><p>go-doudou框架的插件机制通过<code>ServicePlugin</code>接口和依赖注入系统，为开发者提供了一种简洁而强大的方式来构建模块化应用。这种方式特别适合于团队协作开发复杂系统，每个团队可以专注于自己的领域模块，而无需过多关注其他模块的实现细节。</p><p>然而，理解概念和原理只是第一步，如何从零开始实际构建这样的系统才是开发者最关心的问题。在下一篇文章《go-doudou框架中的插件机制与模块化可插拔微内核架构实战（二）》中，我们将提供一个详细的实战指南，带领读者一步步从零开始搭建一个完整的go-doudou微内核架构应用。我们将通过具体的命令和代码示例，展示如何使用go-doudou CLI工具创建工作空间、定义服务接口、实现插件、配置模块间通信等全流程操作，帮助开发者快速掌握这一强大架构模式的实际应用方法。</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2><ul><li>go-doudou官方文档：https://go-doudou.github.io/</li><li>本项目源码地址：https://github.com/wubin1989/go-doudou-rag</li></ul><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/unionj-cloud/go-doudou/edit/main/zh/blog/plugin-mechanism.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wubinwill@gmail.com">武斌</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.2025f35b.js" defer></script>
  </body>
</html>
