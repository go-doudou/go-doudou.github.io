<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.35">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/x-icon" sizes="32x32" href="/favicon.ico"><script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?658d535852e4dcdd8f3934c1c3e87165";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script><meta name="keywords" content="go-doudou,Go语言微服务框架,golang,go-doudou微服务框架,RESTful,微服务,服务注册与发现,负载均衡,熔断限流,grpc,去中心化,golang microservice framework,golang orm,ORM工具,microservice,service discovery,load balancing,circuit breaker,rate limit,低代码平台"><meta name="description" content="go-doudou是一个go语言微服务框架。它同时支持开发单体应用。从定义Go语言接口开始，无须学习任何接口描述语言。内置基于SWIM gossip协议的服务注册与发现的机制，帮助你构建一个健壮的、可扩展的、去中心化的微服务集群。内置强大的代码生成器。"><title>深入解读go-doudou内置服务注册与发现组件 | go-doudou</title>
    <link rel="modulepreload" href="/assets/app.2025f35b.js"><link rel="modulepreload" href="/assets/memberlist.html.b12d1b48.js"><link rel="modulepreload" href="/assets/memberlist.html.3f97c306.js"><link rel="modulepreload" href="/assets/memberlist.6d5ad7c0.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/assets/style.993d40d8.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/zh/" class=""><img class="logo" src="/logo.png" alt="go-doudou"><span class="site-name can-hide">go-doudou</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/zh/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/resources/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/blog/" class="router-link-active" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/contribution/" class="" aria-label="贡献"><!--[--><!--]--> 贡献 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou/releases" rel="noopener noreferrer" target="_blank" aria-label="Release Notes"><!--[--><!--]--> Release Notes <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/memberlist.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/zh/blog/memberlist.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/zh/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/resources/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/blog/" class="router-link-active" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/contribution/" class="" aria-label="贡献"><!--[--><!--]--> 贡献 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou/releases" rel="noopener noreferrer" target="_blank" aria-label="Release Notes"><!--[--><!--]--> Release Notes <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/memberlist.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/zh/blog/memberlist.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">深入解读go-doudou内置服务注册与发现组件 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/memberlist.html#实战案例" class="router-link-active router-link-exact-active sidebar-item" aria-label="实战案例"><!--[--><!--]--> 实战案例 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/memberlist.html#开发环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="开发环境"><!--[--><!--]--> 开发环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#下载代码" class="router-link-active router-link-exact-active sidebar-item" aria-label="下载代码"><!--[--><!--]--> 下载代码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#打包镜像" class="router-link-active router-link-exact-active sidebar-item" aria-label="打包镜像"><!--[--><!--]--> 打包镜像 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#启动整套微服务系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="启动整套微服务系统"><!--[--><!--]--> 启动整套微服务系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#初始化minio" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化minio"><!--[--><!--]--> 初始化minio <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#使用系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用系统"><!--[--><!--]--> 使用系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#架构说明" class="router-link-active router-link-exact-active sidebar-item" aria-label="架构说明"><!--[--><!--]--> 架构说明 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#服务列表" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务列表"><!--[--><!--]--> 服务列表 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#代码解读" class="router-link-active router-link-exact-active sidebar-item" aria-label="代码解读"><!--[--><!--]--> 代码解读 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/zh/blog/memberlist.html#源码解读" class="router-link-active router-link-exact-active sidebar-item" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/memberlist.html#启动流程图" class="router-link-active router-link-exact-active sidebar-item" aria-label="启动流程图"><!--[--><!--]--> 启动流程图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#registry-newnode" class="router-link-active router-link-exact-active sidebar-item" aria-label="registry.NewNode()"><!--[--><!--]--> registry.NewNode() <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#registry-newnode-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="registry.newNode()"><!--[--><!--]--> registry.newNode() <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#memberlist-newmemberlist" class="router-link-active router-link-exact-active sidebar-item" aria-label="memberlist.NewMemberlist"><!--[--><!--]--> memberlist.NewMemberlist <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#m-alivenode" class="router-link-active router-link-exact-active sidebar-item" aria-label="m.aliveNode"><!--[--><!--]--> m.aliveNode <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/memberlist.html#m-schedule" class="router-link-active router-link-exact-active sidebar-item" aria-label="m.schedule"><!--[--><!--]--> m.schedule <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/zh/blog/memberlist.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="深入解读go-doudou内置服务注册与发现组件" tabindex="-1"><a class="header-anchor" href="#深入解读go-doudou内置服务注册与发现组件" aria-hidden="true">#</a> 深入解读go-doudou内置服务注册与发现组件</h1><p>go-doudou是2021年初开源的go语言开发的微服务框架。最初基于hashicorp开源的memberlist库打造了内置于go-doudou框架中开箱即用的遵循SWIM gossip协议的去中心化的服务注册与发现机制。SWIM Gossip协议是一种弱一致性的协议，不仅具有去中心化的特性，还具备服务注册、节点探活、消息广播等机制，非常适合做服务注册与发现中间件。</p><h2 id="实战案例" tabindex="-1"><a class="header-anchor" href="#实战案例" aria-hidden="true">#</a> 实战案例</h2><p>我们通过一个包含前后台全套服务的上传文本文件生成词云图的实战案例来展示用法。</p><h3 id="开发环境" tabindex="-1"><a class="header-anchor" href="#开发环境" aria-hidden="true">#</a> 开发环境</h3><p>需要安装docker和docker-compose开发环境。所有微服务都需打包成docker镜像，然后通过docker-compose命令启动。</p><h3 id="下载代码" tabindex="-1"><a class="header-anchor" href="#下载代码" aria-hidden="true">#</a> 下载代码</h3><p>克隆仓库源码到本地后，请切到wordcloud文件夹。</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">git clone git@github.com:unionj-cloud/go-doudou-tutorials.git
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="打包镜像" tabindex="-1"><a class="header-anchor" href="#打包镜像" aria-hidden="true">#</a> 打包镜像</h3><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">make docker
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="启动整套微服务系统" tabindex="-1"><a class="header-anchor" href="#启动整套微服务系统" aria-hidden="true">#</a> 启动整套微服务系统</h3><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">make up
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="初始化minio" tabindex="-1"><a class="header-anchor" href="#初始化minio" aria-hidden="true">#</a> 初始化minio</h3><p>本案例采用minio来存储用户上传的文件，需要做一些初始化工作。首先打开<a href="http://localhost:9001/" target="_blank" rel="noopener noreferrer">http://localhost:9001/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>，然后用账号密码minio/minio123登录，创建一个桶wordcloud， 并设置为<code>Access Policy</code>设置为<code>public</code>，最后创建<code>access key</code>：testkey和<code>access secret</code>：testsecret。</p><p><img src="/images/minio1.png" alt="go-doudou"><img src="/images/minio2.png" alt="go-doudou"><img src="/images/minio3.png" alt="go-doudou"><img src="/images/minio4.png" alt="go-doudou"><img src="/images/minio5.png" alt="go-doudou"></p><h3 id="使用系统" tabindex="-1"><a class="header-anchor" href="#使用系统" aria-hidden="true">#</a> 使用系统</h3><p>打开<a href="http://localhost:3100/" target="_blank" rel="noopener noreferrer">http://localhost:3100/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>，用默认账号密码jackchen/1234登录，然后上传任意text格式文件，经过一番处理可以看到页面上输出词云图。</p><p><img src="/images/wordcloud.png" alt="go-doudou"></p><h3 id="架构说明" tabindex="-1"><a class="header-anchor" href="#架构说明" aria-hidden="true">#</a> 架构说明</h3><p>本实战案例前端由一个UI服务负责，基于<code>vue-vben-admin</code>框架开发（因前端技术栈不是本文的重点，此处不再赘述），后端由5个RESTful微服务构成。具体说明请看下文的注释。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  wordcloud git:(master) ✗ tree -L 1</span></span>
<span class="line"><span style="color:#DCDCAA;">.</span></span>
<span class="line"><span style="color:#D4D4D4;">├── Makefile</span></span>
<span class="line"><span style="color:#D4D4D4;">├── README.md</span></span>
<span class="line"><span style="color:#D4D4D4;">├── alertmanager</span></span>
<span class="line"><span style="color:#D4D4D4;">├── ddosify</span></span>
<span class="line"><span style="color:#D4D4D4;">├── dingtalkalert</span></span>
<span class="line"><span style="color:#D4D4D4;">├── docker-compose.yml</span></span>
<span class="line"><span style="color:#D4D4D4;">├── esdata</span></span>
<span class="line"><span style="color:#D4D4D4;">├── filebeat.yml</span></span>
<span class="line"><span style="color:#D4D4D4;">├── grafana</span></span>
<span class="line"><span style="color:#D4D4D4;">├── minio</span></span>
<span class="line"><span style="color:#D4D4D4;">├── my</span></span>
<span class="line"><span style="color:#D4D4D4;">├── prometheus</span></span>
<span class="line"><span style="color:#D4D4D4;">├── screencapture1.png</span></span>
<span class="line"><span style="color:#D4D4D4;">├── screencapture2.png</span></span>
<span class="line"><span style="color:#D4D4D4;">├── shellscripts</span></span>
<span class="line"><span style="color:#D4D4D4;">├── sqlscripts</span></span>
<span class="line"><span style="color:#D4D4D4;">├── wordcloud-bff  </span><span style="color:#6A9955;"># BFF服务，为前端提供唯一的接口入口，同时针对前端的需求对数据做裁剪和格式化转换</span></span>
<span class="line"><span style="color:#D4D4D4;">├── wordcloud-maker  </span><span style="color:#6A9955;"># Maker服务，负责根据文本的词频统计结果生成词云图</span></span>
<span class="line"><span style="color:#D4D4D4;">├── wordcloud-seg  </span><span style="color:#6A9955;"># Seg服务，负责对文本内容做中英文分词，并统计词频</span></span>
<span class="line"><span style="color:#D4D4D4;">├── wordcloud-task  </span><span style="color:#6A9955;"># Task服务，负责存储和查询用户创建的词云图任务</span></span>
<span class="line"><span style="color:#D4D4D4;">├── wordcloud-ui</span></span>
<span class="line"><span style="color:#D4D4D4;">└── wordcloud-user  </span><span style="color:#6A9955;"># User服务，负责注册、登录和生成token</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">16 directories, 6 files</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="服务列表" tabindex="-1"><a class="header-anchor" href="#服务列表" aria-hidden="true">#</a> 服务列表</h3><p>读者可以打开<a href="http://localhost:6060/go-doudou/registry" target="_blank" rel="noopener noreferrer">http://localhost:6060/go-doudou/registry<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>查看服务列表。需要输入Http basic账号密码admin/admin。</p><p><img src="/images/registry.png" alt="go-doudou"></p><h3 id="代码解读" tabindex="-1"><a class="header-anchor" href="#代码解读" aria-hidden="true">#</a> 代码解读</h3><p>我们以BFF服务为例，来看一下服务注册与发现相关代码。具体说明请参考下文的注释。</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">package</span><span style="color:#D4D4D4;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">import</span><span style="color:#D4D4D4;"> (</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">main</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 从环境变量中加载配置</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">conf</span><span style="color:#D4D4D4;"> := config.</span><span style="color:#DCDCAA;">LoadFromEnv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// User服务http请求客户端</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">userClient</span><span style="color:#D4D4D4;"> *userclient.UsersvcClient</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Maker服务http请求客户端</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">makerClient</span><span style="color:#D4D4D4;"> *makerclient.WordcloudMakerClient</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Task服务http请求客户端</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">taskClient</span><span style="color:#D4D4D4;"> *taskclient.WordcloudTaskClient</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 从环境变量中读取服务模式，单体还是微服务</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 环境变量名称和值完全可以自定义，与go-doudou框架无关</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 做服务模式的区分只是为了方便本地开发</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> os.</span><span style="color:#DCDCAA;">Getenv</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;GDD_MODE&quot;</span><span style="color:#D4D4D4;">) == </span><span style="color:#CE9178;">&quot;micro&quot;</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 服务注册</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := registry.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			logrus.</span><span style="color:#DCDCAA;">Panicln</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%+v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err))</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 服务下线，释放资源</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> registry.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 创建基于go-doudou内置服务注册与发现机制的客户端负载均衡器</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// User服务的客户端负载均衡器</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">userProvider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewMemberlistServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-usersvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 创建User服务的http请求客户端实例</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">userClient</span><span style="color:#D4D4D4;"> = userclient.</span><span style="color:#DCDCAA;">NewUsersvcClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(userProvider))</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Maker服务的客户端负载均衡器</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makerProvider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewMemberlistServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-makersvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Maker服务的http请求客户端实例</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makerClient</span><span style="color:#D4D4D4;"> = makerclient.</span><span style="color:#DCDCAA;">NewWordcloudMakerClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(makerProvider))</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Task服务的客户端负载均衡器</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">taskProvider</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewMemberlistServiceProvider</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;wordcloud-tasksvc&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// Task服务的http请求客户端实例</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">taskClient</span><span style="color:#D4D4D4;"> = taskclient.</span><span style="color:#DCDCAA;">NewWordcloudTaskClient</span><span style="color:#D4D4D4;">(ddhttp.</span><span style="color:#DCDCAA;">WithProvider</span><span style="color:#D4D4D4;">(taskProvider))</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 直连User服务的http请求客户端实例</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">userClient</span><span style="color:#D4D4D4;"> = userclient.</span><span style="color:#DCDCAA;">NewUsersvcClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 直连Maker服务的http请求客户端实例</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makerClient</span><span style="color:#D4D4D4;"> = makerclient.</span><span style="color:#DCDCAA;">NewWordcloudMakerClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 直连Task服务的http请求客户端实例</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">taskClient</span><span style="color:#D4D4D4;"> = taskclient.</span><span style="color:#DCDCAA;">NewWordcloudTaskClient</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 开启Jaeger调用链监控</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">tracer</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">closer</span><span style="color:#D4D4D4;"> := tracing.</span><span style="color:#DCDCAA;">Init</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> closer.</span><span style="color:#DCDCAA;">Close</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	opentracing.</span><span style="color:#DCDCAA;">SetGlobalTracer</span><span style="color:#D4D4D4;">(tracer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">rec</span><span style="color:#D4D4D4;"> := metrics.</span><span style="color:#DCDCAA;">NewPrometheusRecorder</span><span style="color:#D4D4D4;">(prometheus.DefaultRegisterer)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 给User、Maker、Task服务增加熔断器、超时、重试等弹性与容错机制与Prometheus指标采集</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">userClientProxy</span><span style="color:#D4D4D4;"> := userclient.</span><span style="color:#DCDCAA;">NewUsersvcClientProxy</span><span style="color:#D4D4D4;">(userClient, rec)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">makerClientProxy</span><span style="color:#D4D4D4;"> := makerclient.</span><span style="color:#DCDCAA;">NewWordcloudMakerClientProxy</span><span style="color:#D4D4D4;">(makerClient, rec)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">taskClientProxy</span><span style="color:#D4D4D4;"> := taskclient.</span><span style="color:#DCDCAA;">NewWordcloudTaskClientProxy</span><span style="color:#D4D4D4;">(taskClient, rec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 创建minio客户端</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">endpoint</span><span style="color:#D4D4D4;"> := conf.BizConf.OssEndpoint</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">accessKeyID</span><span style="color:#D4D4D4;"> := conf.BizConf.OssKey</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">secretAccessKey</span><span style="color:#D4D4D4;"> := conf.BizConf.OssSecret</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">useSSL</span><span style="color:#D4D4D4;"> := </span><span style="color:#569CD6;">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Initialize minio client object.</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">minioClient</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := minio.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(endpoint, &amp;minio.Options{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Creds:  credentials.</span><span style="color:#DCDCAA;">NewStaticV4</span><span style="color:#D4D4D4;">(accessKeyID, secretAccessKey, </span><span style="color:#CE9178;">&quot;&quot;</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		Secure: useSSL,</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#DCDCAA;">panic</span><span style="color:#D4D4D4;">(err)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 将User、Maker、Task服务http请求客户端实例、minio客户端实例注入</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">svc</span><span style="color:#D4D4D4;"> := service.</span><span style="color:#DCDCAA;">NewWordcloudBff</span><span style="color:#D4D4D4;">(conf, minioClient, makerClientProxy, taskClientProxy, userClientProxy)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">handler</span><span style="color:#D4D4D4;"> := httpsrv.</span><span style="color:#DCDCAA;">NewWordcloudBffHandler</span><span style="color:#D4D4D4;">(svc)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">srv</span><span style="color:#D4D4D4;"> := ddhttp.</span><span style="color:#DCDCAA;">NewDefaultHttpSrv</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Auth</span><span style="color:#D4D4D4;">(userClientProxy))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">rdb</span><span style="color:#D4D4D4;"> := redis.</span><span style="color:#DCDCAA;">NewClient</span><span style="color:#D4D4D4;">(&amp;redis.Options{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Addr: fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">:6379&quot;</span><span style="color:#D4D4D4;">, conf.RedisConf.Host),</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">fn</span><span style="color:#D4D4D4;"> := redisrate.</span><span style="color:#DCDCAA;">LimitFn</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(ctx context.Context) ratelimit.Limit {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> ratelimit.</span><span style="color:#DCDCAA;">PerSecondBurst</span><span style="color:#D4D4D4;">(conf.ConConf.RatelimitRate, conf.ConConf.RatelimitBurst)</span></span>
<span class="line"><span style="color:#D4D4D4;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddMiddleware</span><span style="color:#D4D4D4;">(</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 增加隔仓机制</span></span>
<span class="line"><span style="color:#D4D4D4;">		ddhttp.</span><span style="color:#DCDCAA;">BulkHead</span><span style="color:#D4D4D4;">(conf.ConConf.BulkheadWorkers, conf.ConConf.BulkheadMaxwaittime),</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 增加基于redis的限流器</span></span>
<span class="line"><span style="color:#D4D4D4;">		httpsrv.</span><span style="color:#DCDCAA;">RedisRateLimit</span><span style="color:#D4D4D4;">(rdb, fn),</span></span>
<span class="line"><span style="color:#D4D4D4;">	)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">AddRoute</span><span style="color:#D4D4D4;">(httpsrv.</span><span style="color:#DCDCAA;">Routes</span><span style="color:#D4D4D4;">(handler)...)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 启动http服务</span></span>
<span class="line"><span style="color:#D4D4D4;">	srv.</span><span style="color:#DCDCAA;">Run</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><h2 id="源码解读" tabindex="-1"><a class="header-anchor" href="#源码解读" aria-hidden="true">#</a> 源码解读</h2><p>go-doudou内置的服务注册与发现机制基于memberlist库开发，同时根据微服务应用场景做了一些改造。memberlist库里有很多宝藏，每次阅读源码都有新的认知。即使读者在实际项目开发中没有采用这种机制，也推荐阅读一番。请读者先浏览一下启动流程图，后文会着重针对几个重要的函数做源码解读。</p><h3 id="启动流程图" tabindex="-1"><a class="header-anchor" href="#启动流程图" aria-hidden="true">#</a> 启动流程图</h3><p><img src="/images/memberlist.png" alt="go-doudou"></p><h3 id="registry-newnode" tabindex="-1"><a class="header-anchor" href="#registry-newnode" aria-hidden="true">#</a> registry.NewNode()</h3><p>go-doudou在这个函数里封装了基于memberlist和基于Nacos的两种机制的初始化流程，根据配置来决定采用哪一种机制，支持两种机制同时采用。</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">(data ...</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;">{}) </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 从环境变量GDD_SERVICE_DISCOVERY_MODE读取配置</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">mode</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> := </span><span style="color:#C586C0;">range</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">getModemap</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">switch</span><span style="color:#D4D4D4;"> mode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">case</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;nacos&quot;</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">			nacos.</span><span style="color:#DCDCAA;">NewNode</span><span style="color:#D4D4D4;">(data...)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">case</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;memberlist&quot;</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// 初始化memberlist机制</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">newNode</span><span style="color:#D4D4D4;">(data...)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">default</span><span style="color:#D4D4D4;">:</span></span>
<span class="line"><span style="color:#D4D4D4;">			logger.</span><span style="color:#DCDCAA;">Warn</span><span style="color:#D4D4D4;">(fmt.</span><span style="color:#DCDCAA;">Sprintf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[go-doudou] unknown service discovery mode: </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, mode))</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="registry-newnode-1" tabindex="-1"><a class="header-anchor" href="#registry-newnode-1" aria-hidden="true">#</a> registry.newNode()</h3><p>在这个函数里创建memberlist实例，上文的启动流程图实际从这里开始。</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">newNode</span><span style="color:#D4D4D4;">(data ...</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;">{}) </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 初始化memberlist配置</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mconf</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">newConf</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 初始化服务本身的http相关配置和元数据，此处略</span></span>
<span class="line"><span style="color:#D4D4D4;">	...</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mmeta</span><span style="color:#D4D4D4;"> := mergedMeta{</span></span>
<span class="line"><span style="color:#D4D4D4;">		Meta: nodeMeta{</span></span>
<span class="line"><span style="color:#D4D4D4;">			Service:       service,</span></span>
<span class="line"><span style="color:#D4D4D4;">			RouteRootPath: rr,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Port:          httpPort,</span></span>
<span class="line"><span style="color:#D4D4D4;">			RegisterAt:    &amp;now,</span></span>
<span class="line"><span style="color:#D4D4D4;">			GoVer:         runtime.</span><span style="color:#DCDCAA;">Version</span><span style="color:#D4D4D4;">(),</span></span>
<span class="line"><span style="color:#D4D4D4;">			GddVer:        buildinfo.GddVer,</span></span>
<span class="line"><span style="color:#D4D4D4;">			BuildUser:     buildinfo.BuildUser,</span></span>
<span class="line"><span style="color:#D4D4D4;">			BuildTime:     buildTime,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Weight:        weight,</span></span>
<span class="line"><span style="color:#D4D4D4;">		},</span></span>
<span class="line"><span style="color:#D4D4D4;">		Data: </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]</span><span style="color:#569CD6;">interface</span><span style="color:#D4D4D4;">{}),</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(data) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">mmeta.Data</span><span style="color:#D4D4D4;"> = data[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">queue</span><span style="color:#D4D4D4;"> := &amp;memberlist.TransmitLimitedQueue{</span></span>
<span class="line"><span style="color:#D4D4D4;">		NumNodes:             numNodes,</span></span>
<span class="line"><span style="color:#D4D4D4;">		RetransmitMultGetter: retransmitMultGetter,</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">BroadcastQueue</span><span style="color:#D4D4D4;"> = queue</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mconf.Delegate</span><span style="color:#D4D4D4;"> = &amp;delegate{</span></span>
<span class="line"><span style="color:#D4D4D4;">		mmeta: mmeta,</span></span>
<span class="line"><span style="color:#D4D4D4;">		queue: queue,</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">mconf.Events</span><span style="color:#D4D4D4;"> = events</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">error</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// createMemberlist实际调用的是memberlist.Create</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 这里这样写是为了单元测试</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">mlist</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">createMemberlist</span><span style="color:#D4D4D4;">(mconf); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> errors.</span><span style="color:#DCDCAA;">Wrap</span><span style="color:#D4D4D4;">(err, </span><span style="color:#CE9178;">&quot;[go-doudou] Failed to create memberlist&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 加入种子节点所在集群</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">join</span><span style="color:#D4D4D4;">(); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		mlist.</span><span style="color:#DCDCAA;">Shutdown</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> errors.</span><span style="color:#DCDCAA;">Wrap</span><span style="color:#D4D4D4;">(err, </span><span style="color:#CE9178;">&quot;[go-doudou] Node register failed&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">local</span><span style="color:#D4D4D4;"> := mlist.</span><span style="color:#DCDCAA;">LocalNode</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">baseUrl</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">BaseUrl</span><span style="color:#D4D4D4;">(local)</span></span>
<span class="line"><span style="color:#D4D4D4;">	logger.</span><span style="color:#DCDCAA;">Infof</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;memberlist created. local node is Node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">, providing </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;"> service at </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">, memberlist port </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">		local.Name, mmeta.Meta.Service, baseUrl, fmt.</span><span style="color:#DCDCAA;">Sprint</span><span style="color:#D4D4D4;">(local.Port))</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#DCDCAA;">registerConfigListener</span><span style="color:#D4D4D4;">(mconf)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="memberlist-newmemberlist" tabindex="-1"><a class="header-anchor" href="#memberlist-newmemberlist" aria-hidden="true">#</a> memberlist.NewMemberlist</h3><p>创建memberlist实例</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">NewMemberlist</span><span style="color:#D4D4D4;">(conf *Config) (*Memberlist, </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 判断协议版本，go-doudou不涉及这块逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.ProtocolVersion &lt; ProtocolVersionMin {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Protocol version &#39;</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&#39; too low. Must be in range: [</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">, </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">]&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">			conf.ProtocolVersion, ProtocolVersionMin, ProtocolVersionMax)</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.ProtocolVersion &gt; ProtocolVersionMax {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Protocol version &#39;</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&#39; too high. Must be in range: [</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">, </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">]&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">			conf.ProtocolVersion, ProtocolVersionMin, ProtocolVersionMax)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(conf.SecretKey) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.Keyring == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">keyring</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">NewKeyring</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, conf.SecretKey)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">conf.Keyring</span><span style="color:#D4D4D4;"> = keyring</span></span>
<span class="line"><span style="color:#D4D4D4;">		} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := conf.Keyring.</span><span style="color:#DCDCAA;">AddKey</span><span style="color:#D4D4D4;">(conf.SecretKey); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := conf.Keyring.</span><span style="color:#DCDCAA;">UseKey</span><span style="color:#D4D4D4;">(conf.SecretKey); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 日志相关配置</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.LogOutput != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> &amp;&amp; conf.Logger != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Cannot specify both LogOutput and Logger. Please choose a single log configuration setting.&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">logDest</span><span style="color:#D4D4D4;"> := conf.LogOutput</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> logDest == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">logDest</span><span style="color:#D4D4D4;"> = os.Stderr</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">logger</span><span style="color:#D4D4D4;"> := conf.Logger</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> logger == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">logger</span><span style="color:#D4D4D4;"> = log.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(logDest, </span><span style="color:#CE9178;">&quot;&quot;</span><span style="color:#D4D4D4;">, log.LstdFlags)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 如果用户没有传入自定义Transport，则创建一个默认Transport</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 负责监听TCP和UDP消息</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">transport</span><span style="color:#D4D4D4;"> := conf.Transport</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> transport == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">nc</span><span style="color:#D4D4D4;"> := &amp;NetTransportConfig{</span></span>
<span class="line"><span style="color:#D4D4D4;">			BindAddrs: []</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">{conf.BindAddr},</span></span>
<span class="line"><span style="color:#D4D4D4;">			BindPort:  conf.BindPort,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Logger:    logger,</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// See comment below for details about the retry in here.</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">makeNetRetry</span><span style="color:#D4D4D4;"> := </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">(limit </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;">) (*NetTransport, </span><span style="color:#4EC9B0;">error</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">error</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">try</span><span style="color:#D4D4D4;"> := </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">; try &lt; limit; try++ {</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">nt</span><span style="color:#D4D4D4;"> *NetTransport</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">nt</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">NewNetTransport</span><span style="color:#D4D4D4;">(nc); err == </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">					</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> nt, </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">				}</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> strings.</span><span style="color:#DCDCAA;">Contains</span><span style="color:#D4D4D4;">(err.</span><span style="color:#DCDCAA;">Error</span><span style="color:#D4D4D4;">(), </span><span style="color:#CE9178;">&quot;address already in use&quot;</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">					logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[DEBUG] memberlist: Got bind error: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">					</span><span style="color:#C586C0;">continue</span></span>
<span class="line"><span style="color:#D4D4D4;">				}</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;failed to obtain an address: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">limit</span><span style="color:#D4D4D4;"> := </span><span style="color:#B5CEA8;">1</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.BindPort == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">limit</span><span style="color:#D4D4D4;"> = </span><span style="color:#B5CEA8;">10</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 如果用户没有指定BindPort，则会尝试10次，绑定一个可用端口，供TCP和UDP共用</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">nt</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">makeNetRetry</span><span style="color:#D4D4D4;">(limit)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, fmt.</span><span style="color:#DCDCAA;">Errorf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;Could not set up network transport: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> conf.BindPort == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">port</span><span style="color:#D4D4D4;"> := nt.</span><span style="color:#DCDCAA;">GetAutoBindPort</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">conf.BindPort</span><span style="color:#D4D4D4;"> = port</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">conf.AdvertisePort</span><span style="color:#D4D4D4;"> = port</span></span>
<span class="line"><span style="color:#D4D4D4;">			logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[DEBUG] memberlist: Using dynamic bind port </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, port)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">transport</span><span style="color:#D4D4D4;"> = nt</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">nodeAwareTransport</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">ok</span><span style="color:#D4D4D4;"> := transport.(NodeAwareTransport)</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !ok {</span></span>
<span class="line"><span style="color:#D4D4D4;">		logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[DEBUG] memberlist: configured Transport is not a NodeAwareTransport and some features may not work as desired&quot;</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">nodeAwareTransport</span><span style="color:#D4D4D4;"> = &amp;shimNodeAwareTransport{transport}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 创建并初始化memberlist实例</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">m</span><span style="color:#D4D4D4;"> := &amp;Memberlist{</span></span>
<span class="line"><span style="color:#D4D4D4;">		config:               conf,</span></span>
<span class="line"><span style="color:#D4D4D4;">		shutdownCh:           </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}),</span></span>
<span class="line"><span style="color:#D4D4D4;">		leaveBroadcast:       </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		transport:            nodeAwareTransport,</span></span>
<span class="line"><span style="color:#D4D4D4;">		handoffCh:            </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">		highPriorityMsgQueue: list.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(),</span></span>
<span class="line"><span style="color:#D4D4D4;">		lowPriorityMsgQueue:  list.</span><span style="color:#DCDCAA;">New</span><span style="color:#D4D4D4;">(),</span></span>
<span class="line"><span style="color:#D4D4D4;">		nodeMap:              </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]*nodeState),</span></span>
<span class="line"><span style="color:#D4D4D4;">		nodeTimers:           </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">]*suspicion),</span></span>
<span class="line"><span style="color:#D4D4D4;">		awareness:            </span><span style="color:#DCDCAA;">newAwareness</span><span style="color:#D4D4D4;">(conf.AwarenessMaxMultiplier),</span></span>
<span class="line"><span style="color:#D4D4D4;">		ackHandlers:          </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">map</span><span style="color:#D4D4D4;">[</span><span style="color:#4EC9B0;">uint32</span><span style="color:#D4D4D4;">]*ackHandler),</span></span>
<span class="line"><span style="color:#D4D4D4;">		broadcasts: &amp;TransmitLimitedQueue{RetransmitMultGetter: </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> conf.RetransmitMult</span></span>
<span class="line"><span style="color:#D4D4D4;">		}},</span></span>
<span class="line"><span style="color:#D4D4D4;">		logger: logger,</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">m.broadcasts.NumNodes</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() </span><span style="color:#4EC9B0;">int</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">estNumNodes</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 刷新对外的Host和端口</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">_</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := m.</span><span style="color:#DCDCAA;">refreshAdvertise</span><span style="color:#D4D4D4;">(); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;">, err</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 开启TCP消息监听goroutine</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">streamListen</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 开启UDP消息监听goroutine</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">packetListen</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 开启针对通过UDP发来的suspectMsg、aliveMsg、deadMsg、weightMsg和userMsg五种消息类型的处理goroutine</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">packetHandler</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m, </span><span style="color:#569CD6;">nil</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br></div></div><h3 id="m-alivenode" tabindex="-1"><a class="header-anchor" href="#m-alivenode" aria-hidden="true">#</a> m.aliveNode</h3><p>这个memberlist实例方法负责处理存活消息，可以是处理其他节点发来的消息，也可以处理自己初始化时将自己设为存活状态的消息。</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (m *Memberlist) </span><span style="color:#DCDCAA;">aliveNode</span><span style="color:#D4D4D4;">(a *alive, notify </span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{}, bootstrap </span><span style="color:#4EC9B0;">bool</span><span style="color:#D4D4D4;">) {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 加锁，确保线程安全</span></span>
<span class="line"><span style="color:#D4D4D4;">	m.nodeLock.</span><span style="color:#DCDCAA;">Lock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> m.nodeLock.</span><span style="color:#DCDCAA;">Unlock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 从m的字典类型的节点缓存nodeMap里取出该存活消息说的节点的名称对应的节点状态值</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">state</span><span style="color:#D4D4D4;">, </span><span style="color:#9CDCFE;">ok</span><span style="color:#D4D4D4;"> := m.nodeMap[a.Node]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 如果本地节点已经主动离开了，且该存活消息说的节点就是自己，则直接返回</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// go-doudou服务节点不存在“主动离开“这种情况，因为群各节点的节点列表缓存不会清除”主动离开”的节点信息，会造成内存泄露</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">hasLeft</span><span style="color:#D4D4D4;">() &amp;&amp; a.Node == m.config.Name {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &gt;= </span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">pMin</span><span style="color:#D4D4D4;"> := a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">pMax</span><span style="color:#D4D4D4;"> := a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">pCur</span><span style="color:#D4D4D4;"> := a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> pMin == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> || pMax == </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> || pMin &gt; pMax {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Ignoring an alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39; (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">) because protocol version(s) are wrong: </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> &lt;= </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> &lt;= </span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> should be &gt;0&quot;</span><span style="color:#D4D4D4;">, a.Node, a.Addr, a.Port, pMin, pCur, pMax)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Alive回调函数，go-doudou框架没有用到，暂时没有找到应用场景</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.Alive != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &lt; </span><span style="color:#B5CEA8;">6</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: ignoring alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39; (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">) because Vsn is not present&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">				a.Node, a.Addr, a.Port)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">node</span><span style="color:#D4D4D4;"> := &amp;Node{</span></span>
<span class="line"><span style="color:#D4D4D4;">			Name: a.Node,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Addr: a.Addr,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Port: a.Port,</span></span>
<span class="line"><span style="color:#D4D4D4;">			Meta: a.Meta,</span></span>
<span class="line"><span style="color:#D4D4D4;">			PMin: a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			PMax: a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			PCur: a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			DMin: a.Vsn[</span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			DMax: a.Vsn[</span><span style="color:#B5CEA8;">4</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">			DCur: a.Vsn[</span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">err</span><span style="color:#D4D4D4;"> := m.config.Alive.</span><span style="color:#DCDCAA;">NotifyAlive</span><span style="color:#D4D4D4;">(node); err != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: ignoring alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39;: </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">				a.Node, err)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 判断是否是我们之前没有见过的新节点，如果是，则放入本地节点缓存字典</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#569CD6;">var</span><span style="color:#D4D4D4;"> </span><span style="color:#9CDCFE;">updatesNode</span><span style="color:#D4D4D4;"> </span><span style="color:#4EC9B0;">bool</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !ok {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 判断是否是我们拉黑的ip，如果是，则直接丢弃消息</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">errCon</span><span style="color:#D4D4D4;"> := m.config.</span><span style="color:#DCDCAA;">AddrAllowed</span><span style="color:#D4D4D4;">(a.Addr)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> errCon != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Rejected node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;"> (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">): </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, a.Node, a.Addr, errCon)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 创建并初始化节点状态</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state</span><span style="color:#D4D4D4;"> = &amp;nodeState{</span></span>
<span class="line"><span style="color:#D4D4D4;">			Node: Node{</span></span>
<span class="line"><span style="color:#D4D4D4;">				Name: a.Node,</span></span>
<span class="line"><span style="color:#D4D4D4;">				Addr: a.Addr,</span></span>
<span class="line"><span style="color:#D4D4D4;">				Port: a.Port,</span></span>
<span class="line"><span style="color:#D4D4D4;">				Meta: a.Meta,</span></span>
<span class="line"><span style="color:#D4D4D4;">			},</span></span>
<span class="line"><span style="color:#D4D4D4;">			State: StateDead,</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 协议版本兼容性相关代码，go-doudou不涉及</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &gt; </span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">4</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 将节点状态放入节点缓存字典</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.nodeMap[a.Node] = state</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 随机取一个offset，目的是在后面做节点交换，相当于对节点列表做一个shuffle，</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 避免连续多个节点都探活失败，增加节点探活机制的开销</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">n</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(m.nodes)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">offset</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">randomOffset</span><span style="color:#D4D4D4;">(n)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 先将该节点状态放到最后，然后再跟位于offset的节点交换位置</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.nodes</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.nodes, state)</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.nodes[offset], m.nodes[n] = m.nodes[n], m.nodes[offset]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 执行节点数量加1的原子性操作</span></span>
<span class="line"><span style="color:#D4D4D4;">		atomic.</span><span style="color:#DCDCAA;">AddUint32</span><span style="color:#D4D4D4;">(&amp;m.numNodes, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 执行到这里说明存活消息说的节点是已知节点，则判断一下新Host和端口跟旧Host和端口是否一致,</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 如果不一致，则执行下面的逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> state.Addr != a.Addr || state.Port != a.Port {</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// 判断新Host是否已被拉黑</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">errCon</span><span style="color:#D4D4D4;"> := m.config.</span><span style="color:#DCDCAA;">AddrAllowed</span><span style="color:#D4D4D4;">(a.Addr)</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> errCon != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">				m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Rejected IP update from </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> to </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> for node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">: </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">, a.Node, state.Addr, a.Addr, errCon)</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// 如果配置了DeadNodeReclaimTime（即必须经过多长时间以后，死亡节点才可以以相同的名称和不同的地址声明自己还活着），则判断是否该时间已过，</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// 如果已过时间，则可以声明自己还活着，只是换了个Host或端口</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">canReclaim</span><span style="color:#D4D4D4;"> := (m.config.DeadNodeReclaimTime &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#D4D4D4;">				time.</span><span style="color:#DCDCAA;">Since</span><span style="color:#D4D4D4;">(state.StateChange) &gt; m.config.DeadNodeReclaimTime)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#6A9955;">// 如果缓存中的节点状态是“主动离开”或已“死亡”，但是可以重新声明存活，则更新缓存中的节点状态</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> state.State == StateLeft || (state.State == StateDead &amp;&amp; canReclaim) {</span></span>
<span class="line"><span style="color:#D4D4D4;">				m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[INFO] memberlist: Updating address for left or failed node </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;"> from </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> to </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">					state.Name, state.Addr, state.Port, a.Addr, a.Port)</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#9CDCFE;">updatesNode</span><span style="color:#D4D4D4;"> = </span><span style="color:#569CD6;">true</span></span>
<span class="line"><span style="color:#D4D4D4;">			} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">                </span><span style="color:#6A9955;">// 如果不满足重新声明存活的条件，则打印节点冲突日志</span></span>
<span class="line"><span style="color:#D4D4D4;">				m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[ERR] memberlist: Conflicting address for </span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">. Mine: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> Theirs: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;"> Old state: </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">					state.Name, state.Addr, state.Port, a.Addr, a.Port, state.State)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#6A9955;">// 如果配置了节点冲突回调函数，则调用该回调函数</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.Conflict != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">					</span><span style="color:#9CDCFE;">other</span><span style="color:#D4D4D4;"> := Node{</span></span>
<span class="line"><span style="color:#D4D4D4;">						Name: a.Node,</span></span>
<span class="line"><span style="color:#D4D4D4;">						Addr: a.Addr,</span></span>
<span class="line"><span style="color:#D4D4D4;">						Port: a.Port,</span></span>
<span class="line"><span style="color:#D4D4D4;">						Meta: a.Meta,</span></span>
<span class="line"><span style="color:#D4D4D4;">					}</span></span>
<span class="line"><span style="color:#D4D4D4;">					m.config.Conflict.</span><span style="color:#DCDCAA;">NotifyConflict</span><span style="color:#D4D4D4;">(&amp;state.Node, &amp;other)</span></span>
<span class="line"><span style="color:#D4D4D4;">				}</span></span>
<span class="line"><span style="color:#D4D4D4;">				</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">			}</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 如果存活消息中的Incarnation属性值小于或等于缓存中的Incarnation属性值，</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 并且既不是关于本地节点的，也不需要更新节点缓存，则丢弃消息。</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// Incarnation属性值相当于一种节点状态的版本控制，或者说是乐观锁</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">isLocalNode</span><span style="color:#D4D4D4;"> := state.Name == m.config.Name</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> a.Incarnation &lt;= state.Incarnation &amp;&amp; !isLocalNode &amp;&amp; !updatesNode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 如果存活消息中的Incarnation属性值小于缓存中的Incarnation属性值，且关于本地节点，则丢弃消息</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> a.Incarnation &lt; state.Incarnation &amp;&amp; isLocalNode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 删除怀疑节点已死的超时器</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#DCDCAA;">delete</span><span style="color:#D4D4D4;">(m.nodeTimers, a.Node)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// Store the old state and meta data</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">oldState</span><span style="color:#D4D4D4;"> := state.State</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">oldMeta</span><span style="color:#D4D4D4;"> := state.Meta</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 如果不是启动时初始化本地节点状态，但是关于本地节点的，</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 则执行下面的逻辑</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !bootstrap &amp;&amp; isLocalNode {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 计算协议版本矩阵</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">versions</span><span style="color:#D4D4D4;"> := []</span><span style="color:#4EC9B0;">uint8</span><span style="color:#D4D4D4;">{</span></span>
<span class="line"><span style="color:#D4D4D4;">			state.PMin, state.PMax, state.PCur,</span></span>
<span class="line"><span style="color:#D4D4D4;">			state.DMin, state.DMax, state.DCur,</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 如果存活消息中的Incarnation属性值与缓存中的节点状态的Incarnation属性值相同，我们需要特殊处理，</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 因为这种情况可能是由于下述情形产生的：</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 1) 以配置C启动，并加入集群</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 2) 强制退出/进程被杀死/服务器关机</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 3) 以配置C&#39;重启，并加入集群</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">//</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 在这种情况下，其他节点和本地节点会看到相同的incarnation属性值，但是节点状态可能已经变了。</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 因此，我们需要做判等。大多数情况下，我们只需要忽略消息，但是有时我们可能需要反驳回去。</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> a.Incarnation == state.Incarnation &amp;&amp;</span></span>
<span class="line"><span style="color:#D4D4D4;">			bytes.</span><span style="color:#DCDCAA;">Equal</span><span style="color:#D4D4D4;">(a.Meta, state.Meta) &amp;&amp;</span></span>
<span class="line"><span style="color:#D4D4D4;">			bytes.</span><span style="color:#DCDCAA;">Equal</span><span style="color:#D4D4D4;">(a.Vsn, versions) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.</span><span style="color:#DCDCAA;">refute</span><span style="color:#D4D4D4;">(state, a.Incarnation)</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.logger.</span><span style="color:#DCDCAA;">Printf</span><span style="color:#D4D4D4;">(</span><span style="color:#CE9178;">&quot;[WARN] memberlist: Refuting an alive message for &#39;</span><span style="color:#9CDCFE;">%s</span><span style="color:#CE9178;">&#39; (</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">:</span><span style="color:#9CDCFE;">%d</span><span style="color:#CE9178;">) meta:(</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> VS </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">), vsn:(</span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;"> VS </span><span style="color:#9CDCFE;">%v</span><span style="color:#CE9178;">)&quot;</span><span style="color:#D4D4D4;">, a.Node, a.Addr, a.Port, a.Meta, state.Meta, a.Vsn, versions)</span></span>
<span class="line"><span style="color:#D4D4D4;">	} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 将该节点存活消息再加入广播队列，广播给其他节点</span></span>
<span class="line"><span style="color:#D4D4D4;">		m.</span><span style="color:#DCDCAA;">encodeBroadcastNotify</span><span style="color:#D4D4D4;">(a.Node, aliveMsg, a, notify)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#6A9955;">// 更新协议版本信息，go-doudou不涉及</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(a.Vsn) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.PCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">2</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMin</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">3</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DMax</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">4</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.DCur</span><span style="color:#D4D4D4;"> = a.Vsn[</span><span style="color:#B5CEA8;">5</span><span style="color:#D4D4D4;">]</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">        </span><span style="color:#6A9955;">// 更新缓存中的节点状态以及Incarnation属性</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Incarnation</span><span style="color:#D4D4D4;"> = a.Incarnation</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Meta</span><span style="color:#D4D4D4;"> = a.Meta</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Addr</span><span style="color:#D4D4D4;"> = a.Addr</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">state.Port</span><span style="color:#D4D4D4;"> = a.Port</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> state.State != StateAlive {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.State</span><span style="color:#D4D4D4;"> = StateAlive</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.StateChange</span><span style="color:#D4D4D4;"> = time.</span><span style="color:#DCDCAA;">Now</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 更新指标监控项，用于计算节点健康值，go-doudou动态计算节点权重时也会算作一个维度</span></span>
<span class="line"><span style="color:#D4D4D4;">	metrics.</span><span style="color:#DCDCAA;">IncrCounter</span><span style="color:#D4D4D4;">([]</span><span style="color:#4EC9B0;">string</span><span style="color:#D4D4D4;">{</span><span style="color:#CE9178;">&quot;memberlist&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;msg&quot;</span><span style="color:#D4D4D4;">, </span><span style="color:#CE9178;">&quot;alive&quot;</span><span style="color:#D4D4D4;">}, </span><span style="color:#B5CEA8;">1</span><span style="color:#D4D4D4;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 执行相关回调函数</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.Events != </span><span style="color:#569CD6;">nil</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> oldState == StateDead || oldState == StateLeft {</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// 如果节点状态从“死亡”或“主动离开”变成“存活”，则执行Join事件的回调函数</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.Node.State</span><span style="color:#D4D4D4;"> = state.State</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.config.Events.</span><span style="color:#DCDCAA;">NotifyJoin</span><span style="color:#D4D4D4;">(&amp;state.Node)</span></span>
<span class="line"><span style="color:#D4D4D4;">		} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> oldState == StateSuspect {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#9CDCFE;">state.Node.State</span><span style="color:#D4D4D4;"> = state.State</span></span>
<span class="line"><span style="color:#D4D4D4;">            </span><span style="color:#6A9955;">// 如果节点状态从“疑似死亡”变成“存活”，则执行SuspectSateChange事件的回调函数</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.config.Events.</span><span style="color:#DCDCAA;">NotifySuspectSateChange</span><span style="color:#D4D4D4;">(&amp;state.Node)</span></span>
<span class="line"><span style="color:#D4D4D4;">		} </span><span style="color:#C586C0;">else</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> !bytes.</span><span style="color:#DCDCAA;">Equal</span><span style="color:#D4D4D4;">(oldMeta, state.Meta) {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#6A9955;">// 如果只是元数据更新，则执行Update事件的回调函数</span></span>
<span class="line"><span style="color:#D4D4D4;">			m.config.Events.</span><span style="color:#DCDCAA;">NotifyUpdate</span><span style="color:#D4D4D4;">(&amp;state.Node)</span></span>
<span class="line"><span style="color:#D4D4D4;">		}</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br></div></div><h3 id="m-schedule" tabindex="-1"><a class="header-anchor" href="#m-schedule" aria-hidden="true">#</a> m.schedule</h3><p>这个方法里实现了memberlist的核心调度逻辑。</p><div class="language-go ext-go line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;"> (m *Memberlist) </span><span style="color:#DCDCAA;">schedule</span><span style="color:#D4D4D4;">() {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 加锁，确保线程安全</span></span>
<span class="line"><span style="color:#D4D4D4;">	m.tickerLock.</span><span style="color:#DCDCAA;">Lock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">defer</span><span style="color:#D4D4D4;"> m.tickerLock.</span><span style="color:#DCDCAA;">Unlock</span><span style="color:#D4D4D4;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 如果定时任务列表不为空，则返回</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(m.tickers) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">return</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 创建用于停止定时任务的无缓冲通道，当我们需要停掉定时任务的时候，我们就关闭它</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#9CDCFE;">stopCh</span><span style="color:#D4D4D4;"> := </span><span style="color:#DCDCAA;">make</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">chan</span><span style="color:#D4D4D4;"> </span><span style="color:#569CD6;">struct</span><span style="color:#D4D4D4;">{})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 创建一个节点探活定时任务</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.ProbeInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">t</span><span style="color:#D4D4D4;"> := time.</span><span style="color:#DCDCAA;">NewTicker</span><span style="color:#D4D4D4;">(m.config.ProbeInterval)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">triggerFuncDynamic</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() time.Duration {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m.config.ProbeInterval</span></span>
<span class="line"><span style="color:#D4D4D4;">		}, t, stopCh, m.probe)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.tickers</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.tickers, t)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 创建一个基于TCP的与其他节点同步节点列表的定时任务</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.PushPullInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">pushPullTrigger</span><span style="color:#D4D4D4;">(stopCh)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 创建一个广播UDP消息的定时任务</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.GossipInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> &amp;&amp; m.config.GossipNodes &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">t</span><span style="color:#D4D4D4;"> := time.</span><span style="color:#DCDCAA;">NewTicker</span><span style="color:#D4D4D4;">(m.config.GossipInterval)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">triggerFuncDynamic</span><span style="color:#D4D4D4;">(</span><span style="color:#569CD6;">func</span><span style="color:#D4D4D4;">() time.Duration {</span></span>
<span class="line"><span style="color:#D4D4D4;">			</span><span style="color:#C586C0;">return</span><span style="color:#D4D4D4;"> m.config.GossipInterval</span></span>
<span class="line"><span style="color:#D4D4D4;">		}, t, stopCh, m.gossip)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.tickers</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.tickers, t)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 创建一个动态计算本地节点权重并广播出去的定时任务</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> m.config.WeightInterval &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">t</span><span style="color:#D4D4D4;"> := time.</span><span style="color:#DCDCAA;">NewTicker</span><span style="color:#D4D4D4;">(m.config.WeightInterval)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#C586C0;">go</span><span style="color:#D4D4D4;"> m.</span><span style="color:#DCDCAA;">triggerFunc</span><span style="color:#D4D4D4;">(m.config.WeightInterval, t.C, stopCh, m.weight)</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.tickers</span><span style="color:#D4D4D4;"> = </span><span style="color:#DCDCAA;">append</span><span style="color:#D4D4D4;">(m.tickers, t)</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#6A9955;">// 如果定时任务列表不为空，则将刚才创建的stopCh通道赋值给m变量的stopTick属性</span></span>
<span class="line"><span style="color:#D4D4D4;">	</span><span style="color:#C586C0;">if</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">len</span><span style="color:#D4D4D4;">(m.tickers) &gt; </span><span style="color:#B5CEA8;">0</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">		</span><span style="color:#9CDCFE;">m.stopTick</span><span style="color:#D4D4D4;"> = stopCh</span></span>
<span class="line"><span style="color:#D4D4D4;">	}</span></span>
<span class="line"><span style="color:#D4D4D4;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本文介绍了go-doudou内置的基于SWIM gossip协议的服务注册与发现机制，然后通过一个上传文本文件生成词云图的实战案例介绍了基本用法， 最后通过启动流程图总览了整个流程中的要点，并对核心源码做了详细解读。希望可以帮助各位gopher更好的理解go-doudou微服务框架的内在机制。</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/unionj-cloud/go-doudou/edit/main/zh/blog/memberlist.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wubinwill@gmail.com">武斌</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.2025f35b.js" defer></script>
  </body>
</html>
