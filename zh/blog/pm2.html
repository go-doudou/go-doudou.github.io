<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.35">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/x-icon" sizes="32x32" href="/favicon.ico"><script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?658d535852e4dcdd8f3934c1c3e87165";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script><meta name="keywords" content="go-doudou,Go语言微服务框架,golang,go-doudou微服务框架,RESTful,微服务,服务注册与发现,负载均衡,熔断限流,grpc,去中心化,golang microservice framework,golang orm,ORM工具,microservice,service discovery,load balancing,circuit breaker,rate limit,低代码平台"><meta name="description" content="go-doudou是一个go语言微服务框架。它同时支持开发单体应用。从定义Go语言接口开始，无须学习任何接口描述语言。内置基于SWIM gossip协议的服务注册与发现的机制，帮助你构建一个健壮的、可扩展的、去中心化的微服务集群。内置强大的代码生成器。"><title>如何用pm2部署go-doudou服务（单体篇） | go-doudou</title>
    <link rel="modulepreload" href="/assets/app.2025f35b.js"><link rel="modulepreload" href="/assets/pm2.html.fd51feaa.js"><link rel="modulepreload" href="/assets/pm2.html.ab5ff25b.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/assets/style.993d40d8.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/zh/" class=""><img class="logo" src="/logo.png" alt="go-doudou"><span class="site-name can-hide">go-doudou</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/zh/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/resources/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/blog/" class="router-link-active" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/contribution/" class="" aria-label="贡献"><!--[--><!--]--> 贡献 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou/releases" rel="noopener noreferrer" target="_blank" aria-label="Release Notes"><!--[--><!--]--> Release Notes <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/pm2.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/zh/blog/pm2.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/zh/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/resources/" class="" aria-label="资源"><!--[--><!--]--> 资源 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/blog/" class="router-link-active" aria-label="博客"><!--[--><!--]--> 博客 <!--[--><!--]--></a></div><div class="navbar-item"><a href="/zh/contribution/" class="" aria-label="贡献"><!--[--><!--]--> 贡献 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou/releases" rel="noopener noreferrer" target="_blank" aria-label="Release Notes"><!--[--><!--]--> Release Notes <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="选择语言"><span class="title">选择语言</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/pm2.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/zh/blog/pm2.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/unionj-cloud/go-doudou" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">如何用pm2部署go-doudou服务（单体篇） <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/pm2.html#pm2的主要功能" class="router-link-active router-link-exact-active sidebar-item" aria-label="pm2的主要功能"><!--[--><!--]--> pm2的主要功能 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#pm2相比docker的优劣势" class="router-link-active router-link-exact-active sidebar-item" aria-label="pm2相比docker的优劣势"><!--[--><!--]--> pm2相比docker的优劣势 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/pm2.html#优势" class="router-link-active router-link-exact-active sidebar-item" aria-label="优势"><!--[--><!--]--> 优势 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#劣势" class="router-link-active router-link-exact-active sidebar-item" aria-label="劣势"><!--[--><!--]--> 劣势 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/zh/blog/pm2.html#服务器准备" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务器准备"><!--[--><!--]--> 服务器准备 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#服务器配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务器配置"><!--[--><!--]--> 服务器配置 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/pm2.html#安装go" class="router-link-active router-link-exact-active sidebar-item" aria-label="安装go"><!--[--><!--]--> 安装go <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#安装pm2" class="router-link-active router-link-exact-active sidebar-item" aria-label="安装pm2"><!--[--><!--]--> 安装pm2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#安装mysql" class="router-link-active router-link-exact-active sidebar-item" aria-label="安装mysql"><!--[--><!--]--> 安装mysql <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/zh/blog/pm2.html#实战案例" class="router-link-active router-link-exact-active sidebar-item" aria-label="实战案例"><!--[--><!--]--> 实战案例 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/zh/blog/pm2.html#克隆代码" class="router-link-active router-link-exact-active sidebar-item" aria-label="克隆代码"><!--[--><!--]--> 克隆代码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#创建表结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建表结构"><!--[--><!--]--> 创建表结构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#pm2-deploy命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="pm2 deploy命令"><!--[--><!--]--> pm2 deploy命令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#pm2部署配置文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="pm2部署配置文件"><!--[--><!--]--> pm2部署配置文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#deploy-sh脚本" class="router-link-active router-link-exact-active sidebar-item" aria-label="deploy.sh脚本"><!--[--><!--]--> deploy.sh脚本 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/zh/blog/pm2.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/zh/blog/pm2.html#参考链接" class="router-link-active router-link-exact-active sidebar-item" aria-label="参考链接"><!--[--><!--]--> 参考链接 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="如何用pm2部署go-doudou服务-单体篇" tabindex="-1"><a class="header-anchor" href="#如何用pm2部署go-doudou服务-单体篇" aria-hidden="true">#</a> 如何用pm2部署go-doudou服务（单体篇）</h1><p>在我的职业生涯早期有几年的全职nodejs全栈工程师的经历，当年部署nodejs后端服务一般都是用pm2。pm2是docker兴起之前nodejs生态里最知名也是应用最普遍的进程管理工具。实际上，不止是nodejs后端服务，任何编程语言写的程序，不论是给前端工程师提供接口的后端服务，还是爬虫程序，还是定时任务之类的后台程序，都可以用pm2来取代<code>nohup</code>、<code>screen</code>等linux运维工程师才比较熟悉的工具，由程序开发者自己实现部署。两年前，我在简书上发表过一篇介绍用pm2部署java服务的文章，链接发到这里：<a href="https://www.jianshu.com/p/9062ba95f9df" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/9062ba95f9df<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>，读者中如果有java程序员，也可以参考。在docker和k8s大流行的今天，我相信pm2依然在一些中小企业有很高的应用价值。</p><p>本文将通过一个用go-doudou微服务框架开发的单体服务<code>usersvc</code>来演示具体的用法。我在掘金上已经发表了一篇讲解这个服务如何开发的教程，<a href="https://juejin.cn/post/7046936284438200333" target="_blank" rel="noopener noreferrer">快速上手go-doudou开发单体RESTful服务<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>，各位读者如果感兴趣，可以先跳过去阅读，然后再回来阅读本篇文章。</p><h2 id="pm2的主要功能" tabindex="-1"><a class="header-anchor" href="#pm2的主要功能" aria-hidden="true">#</a> pm2的主要功能</h2><p>可以说pm2是为nodejs应用量身打造的进程管理工具，有丰富的功能。我这里主要想总结一下用pm2管理非nodejs应用可以用到的主要功能：</p><ul><li>支持从你将最新代码推到远程代码仓库以后全自动地开始并最终完成整套程序部署流程</li><li>支持通过ssh公私钥的鉴权机制免密码登录服务器</li><li>支持同时部署到多台服务器</li><li>支持在单台服务器同时部署多份副本（不适用对外的服务程序，因为会报端口号已占用的错误）</li><li>支持配置适用于不同环境的多套配置，并在程序启动时设置采用哪套环境的配置</li><li>支持配置多种钩子函数，方便在部署前后执行自定义的脚本或者命令</li><li>支持方便地查看程序的运行状态，比如重启次数、运行时长、CPU和内存占用等等</li><li>支持方便地查看程序的基本信息，比如启动参数、日志路径、创建时间、git提交hash等等</li><li>支持方便地查看程序日志，也可以通过<code>pm2-logrotate</code>等插件管理日志</li><li>支持方便地配置开机启动</li><li>支持限制程序的内存占用，达到最大值以后重启</li></ul><h2 id="pm2相比docker的优劣势" tabindex="-1"><a class="header-anchor" href="#pm2相比docker的优劣势" aria-hidden="true">#</a> pm2相比docker的优劣势</h2><p>以下对比，仅仅是站在一个软件开发者的视角，从单纯实现将程序部署上线和在代码修改后更新线上程序的目标出发，做的一些不成熟的经验总结，供读者参考。</p><h3 id="优势" tabindex="-1"><a class="header-anchor" href="#优势" aria-hidden="true">#</a> 优势</h3><ul><li>十分轻量，对服务器资源的开销小</li><li>支持单纯依靠pm2的机制实现自动化部署</li><li>支持一行命令部署到多台服务器</li><li>上手简单，开发者友好</li></ul><h3 id="劣势" tabindex="-1"><a class="header-anchor" href="#劣势" aria-hidden="true">#</a> 劣势</h3><ul><li>没办法限制CPU占用，资源隔离性基本没有</li><li>生态显然没有docker强大</li></ul><h2 id="服务器准备" tabindex="-1"><a class="header-anchor" href="#服务器准备" aria-hidden="true">#</a> 服务器准备</h2><p>需要一台centos系统服务器或者在本地电脑里通过虚拟机安装centos系统</p><h2 id="服务器配置" tabindex="-1"><a class="header-anchor" href="#服务器配置" aria-hidden="true">#</a> 服务器配置</h2><h3 id="安装go" tabindex="-1"><a class="header-anchor" href="#安装go" aria-hidden="true">#</a> 安装go</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;"># 下载go安装包</span></span>
<span class="line"><span style="color:#D4D4D4;">wget https://dl.google.com/go/go1.17.8.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#6A9955;"># 解压</span></span>
<span class="line"><span style="color:#D4D4D4;">tar -zxvf go1.17.8.linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#6A9955;"># 将解压出的go文件夹移到/usr/local路径</span></span>
<span class="line"><span style="color:#D4D4D4;">mv go /usr/local</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>将<code>/usr/local/go/bin</code>配置到<code>PATH</code>环境变量。可以在<code>~/.zshrc</code>或者<code>~/.bashrc</code>文件里加入下面的配置代码：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> PATH=</span><span style="color:#9CDCFE;">$PATH</span><span style="color:#D4D4D4;">:/usr/local/go/bin</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>创建软链接，非root用户需要加<code>sudo</code>前缀</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">ln -s /usr/local/go/bin/go /usr/bin/go
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="安装pm2" tabindex="-1"><a class="header-anchor" href="#安装pm2" aria-hidden="true">#</a> 安装pm2</h3><p>首先安装nodejs</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">yum update &amp;&amp; yum install -y nodejs</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>然后安装pm2，非root用户需要加<code>sudo</code>前缀</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">npm install -g pm2 --registry=https://registry.npm.taobao.org</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>最后创建软链接，非root用户需要加<code>sudo</code>前缀</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  ~ which node</span></span>
<span class="line"><span style="color:#D4D4D4;">/root/.nvm/versions/node/v14.19.1/bin/node</span></span>
<span class="line"><span style="color:#D4D4D4;">➜  ~ ln -s /root/.nvm/versions/node/v14.19.1/bin/node /usr/bin/node</span></span>
<span class="line"><span style="color:#D4D4D4;">➜  ~ which pm2</span></span>
<span class="line"><span style="color:#D4D4D4;">/root/.nvm/versions/node/v14.19.1/bin/pm2</span></span>
<span class="line"><span style="color:#D4D4D4;">➜  ~ ln -s /root/.nvm/versions/node/v14.19.1/bin/pm2 /usr/bin/pm2</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="安装mysql" tabindex="-1"><a class="header-anchor" href="#安装mysql" aria-hidden="true">#</a> 安装mysql</h3><p>本文要演示的实战案例采用mysql数据库做数据持久化。读者可以根据自己的实际情况选择是否跳过本节。</p><p>添加mysql仓库地址</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">yum localinstall https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>在mysql官网<a href="https://dev.mysql.com/doc/refman/5.7/en/checking-gpg-signature.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/checking-gpg-signature.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a>找到最新的gpg公钥，通过vi命令复制黏贴到 <code>~/mysql5.7_pubkey.asc</code>文件里</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">vi mysql5.7_pubkey.asc</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>导入公钥到mysql和rpm</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">gpg --import mysql5.7_pubkey.asc</span></span>
<span class="line"><span style="color:#D4D4D4;">rpm --import mysql5.7_pubkey.asc</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>安装mysql5.7</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">yum install -y mysql-community-server</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>为了演示方便，我们把mysql的root用户的密码改为1234。生产环境一定不要设置这么简单的密码。首先需要通过vi命令修改<code>/etc/my.cnf</code>文件，在末尾加一行<code>validate_password = OFF</code>，关闭密码规则校验。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">vi /etc/my.cnf</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>然后，我们启动mysql服务实例。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">systemctl start mysqld </span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>再查看一下mysql服务的状态，看是否已成功启动。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  ~ systemctl status mysqld </span></span>
<span class="line"><span style="color:#D4D4D4;">● mysqld.service - MySQL Server</span></span>
<span class="line"><span style="color:#D4D4D4;">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span></span>
<span class="line"><span style="color:#D4D4D4;">   Active: active (running) since 四 2022-05-05 09:09:41 CST; 33min ago</span></span>
<span class="line"><span style="color:#D4D4D4;">     Docs: man:mysqld(8)</span></span>
<span class="line"><span style="color:#D4D4D4;">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span></span>
<span class="line"><span style="color:#D4D4D4;">  Process: 1156 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid </span><span style="color:#9CDCFE;">$MYSQLD_OPTS</span><span style="color:#D4D4D4;"> (code=exited, status=0/SUCCESS)</span></span>
<span class="line"><span style="color:#D4D4D4;">  Process: 1132 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span></span>
<span class="line"><span style="color:#D4D4D4;"> Main PID: 1159 (mysqld)</span></span>
<span class="line"><span style="color:#D4D4D4;">    Tasks: 28</span></span>
<span class="line"><span style="color:#D4D4D4;">   Memory: 185.1M</span></span>
<span class="line"><span style="color:#D4D4D4;">   CGroup: /system.slice/mysqld.service</span></span>
<span class="line"><span style="color:#D4D4D4;">           └─1159 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">5月 05 09:09:40 VM-0-17-centos systemd[1]: Starting MySQL Server...</span></span>
<span class="line"><span style="color:#D4D4D4;">5月 05 09:09:41 VM-0-17-centos systemd[1]: Started MySQL Server.</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>mysql在安装的时候，会初始化一个临时的root密码，我们可以通过如下命令找到：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">grep </span><span style="color:#CE9178;">&#39;password&#39;</span><span style="color:#D4D4D4;"> /var/log/mysqld.log</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>临时密码就在命令行终端输出的第一行日志的结尾。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  ~ grep </span><span style="color:#CE9178;">&#39;password&#39;</span><span style="color:#D4D4D4;"> /var/log/mysqld.log</span></span>
<span class="line"><span style="color:#D4D4D4;">2022-05-05T00:55:13.552165Z 1 [Note] A temporary password is generated </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> root@localhost: .B&lt;UYdtda3rG</span></span>
<span class="line"><span style="color:#D4D4D4;">2022-05-05T00:55:17.373732Z 0 [Note] Shutting down plugin </span><span style="color:#CE9178;">&#39;validate_password&#39;</span></span>
<span class="line"><span style="color:#D4D4D4;">2022-05-05T00:55:18.983662Z 0 [Note] Shutting down plugin </span><span style="color:#CE9178;">&#39;sha256_password&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们复制出来临时密码以后，再执行如下命令：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">mysql_secure_installation</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>根据提示将root密码改为1234。后面出现yes or no的输入提示，都输入no即可，即不做任何修改。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">The existing password </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> the user account root has expired. Please </span><span style="color:#DCDCAA;">set</span><span style="color:#D4D4D4;"> a new password.</span></span>
<span class="line"><span style="color:#D4D4D4;">New password:</span></span>
<span class="line"><span style="color:#D4D4D4;">Re-enter new password:</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>测试一下，密码是否修改成功，然后创建一个数据库<code>tutorial</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  ~ mysql -uroot -p1234</span></span>
<span class="line"><span style="color:#D4D4D4;">mysql: [Warning] Using a password on the </span><span style="color:#DCDCAA;">command</span><span style="color:#D4D4D4;"> line interface can be insecure.</span></span>
<span class="line"><span style="color:#D4D4D4;">Welcome to the MySQL monitor.  Commands end with ; or </span><span style="color:#D7BA7D;">\g</span><span style="color:#D4D4D4;">.</span></span>
<span class="line"><span style="color:#D4D4D4;">Your MySQL connection id is 20</span></span>
<span class="line"><span style="color:#D4D4D4;">Server version: 5.7.38 MySQL Community Server (GPL)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Copyright (c) 2000, 2022, Oracle and/or its affiliates.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Oracle is a registered trademark of Oracle Corporation and/or its</span></span>
<span class="line"><span style="color:#D4D4D4;">affiliates. Other names may be trademarks of their respective</span></span>
<span class="line"><span style="color:#D4D4D4;">owners.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Type </span><span style="color:#CE9178;">&#39;help;&#39;</span><span style="color:#D4D4D4;"> or </span><span style="color:#CE9178;">&#39;\h&#39;</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> help. Type </span><span style="color:#CE9178;">&#39;\c&#39;</span><span style="color:#D4D4D4;"> to clear the current input statement.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; CREATE SCHEMA </span><span style="color:#CE9178;">`tutorial`</span><span style="color:#D4D4D4;"> DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_general_ci;</span></span>
<span class="line"><span style="color:#D4D4D4;">Query OK, 1 row affected (0.00 sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; </span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>最后，我们需要赋予root用户从任意ip远程访问的权限，这个也是为了演示方便，生产环境不建议这么搞。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">CREATE USER </span><span style="color:#CE9178;">&#39;root&#39;</span><span style="color:#D4D4D4;">@</span><span style="color:#CE9178;">&#39;%&#39;</span><span style="color:#D4D4D4;"> IDENTIFIED BY </span><span style="color:#CE9178;">&#39;1234&#39;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">GRANT ALL PRIVILEGES ON *.* TO </span><span style="color:#CE9178;">&#39;root&#39;</span><span style="color:#D4D4D4;">@</span><span style="color:#CE9178;">&#39;%&#39;</span><span style="color:#D4D4D4;">;</span></span>
<span class="line"><span style="color:#D4D4D4;">FLUSH PRIVILEGES;</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>至此服务器相关的配置工作已经完毕。</p><h2 id="实战案例" tabindex="-1"><a class="header-anchor" href="#实战案例" aria-hidden="true">#</a> 实战案例</h2><p>下面我们通过一个案例说明和演示pm2的用法。</p><h3 id="克隆代码" tabindex="-1"><a class="header-anchor" href="#克隆代码" aria-hidden="true">#</a> 克隆代码</h3><p>克隆到代码以后，请切到<code>usersvc</code>路径下。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">git clone git@github.com:unionj-cloud/go-doudou-tutorials.git</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="创建表结构" tabindex="-1"><a class="header-anchor" href="#创建表结构" aria-hidden="true">#</a> 创建表结构</h3><p>因为服务器的mysql实例的<code>tutorial</code>数据库里还没有表，所以我们需要先通过<code>go-doudou ddl</code>命令创建表结构。执行命令之前，我们需要在本地创建一个配置文件<code>.env.test.local</code>，将如下配置复制进去：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;"># 本地开发需连接服务器的公网地址</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_HOST=162.14.116.92</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_PORT=3306</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_USER=root</span></span>
<span class="line"><span style="color:#D4D4D4;">DB_PASSWD=1234</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这样我们在本地执行go-doudou命令，就可以直接更新远程mysql服务实例的表结构。另外，我们需要把这个本地配置文件加到<code>.gitignore</code>文件里，不能上传到git仓库，也不能让线上服务启动时加载到这个配置文件。现在我们可以执行命令了。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  usersvc git:(master) ✗ go-doudou ddl --env=test --pre=t_   </span></span>
<span class="line"><span style="color:#D4D4D4;">INFO[2022-05-05 10:11:40] Type: name=User                              </span></span>
<span class="line"><span style="color:#D4D4D4;">CREATE TABLE </span><span style="color:#CE9178;">`t_user`</span><span style="color:#D4D4D4;"> (</span></span>
<span class="line"><span style="color:#CE9178;">`id`</span><span style="color:#D4D4D4;"> int(11) NOT NULL AUTO_INCREMENT,</span></span>
<span class="line"><span style="color:#CE9178;">`username`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;username&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">`password`</span><span style="color:#D4D4D4;"> varchar(60) NOT NULL comment </span><span style="color:#CE9178;">&#39;password&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">`name`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;real name&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">`phone`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;phone number&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">`dept`</span><span style="color:#D4D4D4;"> varchar(45) NOT NULL comment </span><span style="color:#CE9178;">&#39;department&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">`avatar`</span><span style="color:#D4D4D4;"> varchar(255) NOT NULL comment </span><span style="color:#CE9178;">&#39;user avatar&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#CE9178;">`create_at`</span><span style="color:#D4D4D4;"> datetime NULL DEFAULT CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color:#CE9178;">`update_at`</span><span style="color:#D4D4D4;"> datetime NULL DEFAULT CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color:#CE9178;">`delete_at`</span><span style="color:#D4D4D4;"> datetime NULL,</span></span>
<span class="line"><span style="color:#D4D4D4;">PRIMARY KEY (</span><span style="color:#CE9178;">`id`</span><span style="color:#D4D4D4;">),</span></span>
<span class="line"><span style="color:#D4D4D4;">UNIQUE INDEX </span><span style="color:#CE9178;">`username_idx`</span><span style="color:#D4D4D4;"> (</span><span style="color:#CE9178;">`username`</span><span style="color:#D4D4D4;"> asc))</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以连上mysql检查一下表结构是否创建成功。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  usersvc git:(master) ✗ mysql -h 162.14.116.92 -P 3306 -uroot -p1234</span></span>
<span class="line"><span style="color:#D4D4D4;">mysql: [Warning] Using a password on the </span><span style="color:#DCDCAA;">command</span><span style="color:#D4D4D4;"> line interface can be insecure.</span></span>
<span class="line"><span style="color:#D4D4D4;">Welcome to the MySQL monitor.  Commands end with ; or </span><span style="color:#D7BA7D;">\g</span><span style="color:#D4D4D4;">.</span></span>
<span class="line"><span style="color:#D4D4D4;">Your MySQL connection id is 22</span></span>
<span class="line"><span style="color:#D4D4D4;">Server version: 5.7.38 MySQL Community Server (GPL)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Oracle is a registered trademark of Oracle Corporation and/or its</span></span>
<span class="line"><span style="color:#D4D4D4;">affiliates. Other names may be trademarks of their respective</span></span>
<span class="line"><span style="color:#D4D4D4;">owners.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Type </span><span style="color:#CE9178;">&#39;help;&#39;</span><span style="color:#D4D4D4;"> or </span><span style="color:#CE9178;">&#39;\h&#39;</span><span style="color:#D4D4D4;"> </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> help. Type </span><span style="color:#CE9178;">&#39;\c&#39;</span><span style="color:#D4D4D4;"> to clear the current input statement.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; use tutorial;</span></span>
<span class="line"><span style="color:#D4D4D4;">Reading table information </span><span style="color:#C586C0;">for</span><span style="color:#D4D4D4;"> completion of table and column names</span></span>
<span class="line"><span style="color:#D4D4D4;">You can turn off this feature to get a quicker startup with -A</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">Database changed</span></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; show tables;</span></span>
<span class="line"><span style="color:#D4D4D4;">+--------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| Tables_in_tutorial |</span></span>
<span class="line"><span style="color:#D4D4D4;">+--------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| t_user             |</span></span>
<span class="line"><span style="color:#D4D4D4;">+--------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">1 row </span><span style="color:#C586C0;">in</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">set</span><span style="color:#D4D4D4;"> (0.00 sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; describe t_user;</span></span>
<span class="line"><span style="color:#D4D4D4;">+-----------+--------------+------+-----+-------------------+-----------------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| Field     | Type         | Null | Key | Default           | Extra                       |</span></span>
<span class="line"><span style="color:#D4D4D4;">+-----------+--------------+------+-----+-------------------+-----------------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">| id        | int(11)      | NO   | PRI | NULL              | auto_increment              |</span></span>
<span class="line"><span style="color:#D4D4D4;">| username  | varchar(45)  | NO   | UNI | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| password  | varchar(60)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| name      | varchar(45)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| phone     | varchar(45)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| dept      | varchar(45)  | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| avatar    | varchar(255) | NO   |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| create_at | datetime     | YES  |     | CURRENT_TIMESTAMP |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">| update_at | datetime     | YES  |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |</span></span>
<span class="line"><span style="color:#D4D4D4;">| delete_at | datetime     | YES  |     | NULL              |                             |</span></span>
<span class="line"><span style="color:#D4D4D4;">+-----------+--------------+------+-----+-------------------+-----------------------------+</span></span>
<span class="line"><span style="color:#D4D4D4;">10 rows </span><span style="color:#C586C0;">in</span><span style="color:#D4D4D4;"> </span><span style="color:#DCDCAA;">set</span><span style="color:#D4D4D4;"> (0.02 sec)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D4D4D4;">mysql&gt; </span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="pm2-deploy命令" tabindex="-1"><a class="header-anchor" href="#pm2-deploy命令" aria-hidden="true">#</a> pm2 deploy命令</h3><p>部署服务时我们主要用到pm2的<code>deploy</code>命令。具体用法，请看下面代码块中的说明。</p><div class="language-text ext-text line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">&gt; pm2 deploy &lt;配置文件&gt; &lt;环境&gt; &lt;命令&gt;

  命令列表:
    setup                执行远程初始化命令
    update               部署最新版本
    revert [n]           回滚到最近第n次部署的版本，n的默认值是1
    curr[ent]            输出当前线上版本的代码提交的7位hash
    prev[ious]           输出上一次线上版本的代码提交的7位hash
    exec|run &lt;cmd&gt;       执行&lt;cmd&gt;参数指定的命令
    list                 输出至今为止部署过的所有版本的代码提交的7位hash
    [ref]                部署配置文件中的&quot;ref&quot;属性指定的版本，或者是最新的git标签
</span></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我个人实践中用<code>setup</code>和<code>update</code>命令比较多。</p><h4 id="pm2初始化" tabindex="-1"><a class="header-anchor" href="#pm2初始化" aria-hidden="true">#</a> pm2初始化</h4><p>采用pm2部署和更新线上服务之前，我们需要先执行pm2的初始化命令。pm2配置文件<code>ecosystem.config.js</code>已经在代码里了，我们稍后讲解。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> setup</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>如果看到命令行终端最后一行输出<code>--&gt; Success</code>，即表示初始化成功。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  usersvc git:(master) pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> setup</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Deploying to </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> environment</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; on host 162.14.116.92</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ hook pre-setup</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ running setup</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ cloning git@github.com:unionj-cloud/go-doudou-tutorials.git</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ full fetch</span></span>
<span class="line"><span style="color:#D4D4D4;">正克隆到 </span><span style="color:#CE9178;">&#39;/root/deploy/go-doudou-tutorials/source&#39;</span><span style="color:#D4D4D4;">...</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ hook post-setup</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ setup </span><span style="color:#DCDCAA;">complete</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Success</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="pm2部署" tabindex="-1"><a class="header-anchor" href="#pm2部署" aria-hidden="true">#</a> pm2部署</h4><p>还是先上命令。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> update</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>如果看到命令行终端最后一行输出<code>--&gt; Success</code>，即表示部署成功。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#D4D4D4;">➜  usersvc git:(master) pm2 deploy ecosystem.config.js </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> update</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Deploying to </span><span style="color:#DCDCAA;">test</span><span style="color:#D4D4D4;"> environment</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; on host 162.14.116.92</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ deploying origin/master</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ executing pre-deploy-local</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ hook pre-deploy</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ fast forward master</span></span>
<span class="line"><span style="color:#D4D4D4;">已经位于 </span><span style="color:#CE9178;">&#39;master&#39;</span></span>
<span class="line"><span style="color:#D4D4D4;">来自 github.com:unionj-cloud/go-doudou-tutorials</span></span>
<span class="line"><span style="color:#D4D4D4;"> * branch            master     -&gt; FETCH_HEAD</span></span>
<span class="line"><span style="color:#D4D4D4;">Already up-to-date.</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ executing post-deploy </span><span style="color:#CE9178;">`cd usersvc </span><span style="color:#D4D4D4;">&amp;&amp;</span><span style="color:#CE9178;"> sh deploy.sh test`</span></span>
<span class="line"><span style="color:#D4D4D4;">[PM2][WARN] Applications usersvc not running, starting...</span></span>
<span class="line"><span style="color:#D4D4D4;">[PM2] App [usersvc] launched (1 instances)</span></span>
<span class="line"><span style="color:#D4D4D4;">┌─────┬────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐</span></span>
<span class="line"><span style="color:#D4D4D4;">│ id  │ name       │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │</span></span>
<span class="line"><span style="color:#D4D4D4;">├─────┼────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤</span></span>
<span class="line"><span style="color:#D4D4D4;">│ 0   │ usersvc    │ default     │ N/A     │ fork    │ 10737    │ 0s     │ 0    │ online    │ 0%       │ 9.6mb    │ root     │ disabled │</span></span>
<span class="line"><span style="color:#D4D4D4;">└─────┴────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ hook </span><span style="color:#DCDCAA;">test</span></span>
<span class="line"><span style="color:#D4D4D4;">  ○ successfully deployed origin/master</span></span>
<span class="line"><span style="color:#D4D4D4;">--&gt; Success</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="pm2部署配置文件" tabindex="-1"><a class="header-anchor" href="#pm2部署配置文件" aria-hidden="true">#</a> pm2部署配置文件</h3><p>上文已经提到<code>ecosystem.config.js</code>文件是pm2部署命令所读取的配置文件，我们来看一下这个文件，说明已经以注释形式写在了代码上面。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">// 不同部署环境下程序所需要读取的环境变量配置</span></span>
<span class="line"><span style="color:#569CD6;">const</span><span style="color:#D4D4D4;"> </span><span style="color:#4FC1FF;">ENV</span><span style="color:#D4D4D4;"> = {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 开发环境</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;env_dev&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// GDD_ENV环境变量相当于Java生态的spring boot框架的spring.profiles.active配置</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#CE9178;">&quot;GDD_ENV&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;dev&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">  },</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 生成环境</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;env_prod&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#CE9178;">&quot;GDD_ENV&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;prod&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">  },</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 测试环境</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;env_test&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#CE9178;">&quot;GDD_ENV&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;test&quot;</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#4EC9B0;">module</span><span style="color:#D4D4D4;">.</span><span style="color:#4EC9B0;">exports</span><span style="color:#D4D4D4;"> = {</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#6A9955;">// 可以在apps属性里配置多个应用</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#CE9178;">&quot;apps&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> [</span></span>
<span class="line"><span style="color:#D4D4D4;">    {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 应用名称</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;name&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;usersvc&quot;</span><span style="color:#D4D4D4;">,  </span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 启动文件，这里是go build编译以后的二进制可执行文件，可以是相对路径，也可以是绝对路径</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;script&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;./api&quot;</span><span style="color:#D4D4D4;">,  </span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 工作目录，因为go-doudou-tutorials是一个monorepo仓库，所以需要加上这个配置，</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 默认的工作目录是/root/deploy/go-doudou-tutorials/current</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;cwd&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;/root/deploy/go-doudou-tutorials/current/usersvc&quot;</span><span style="color:#D4D4D4;">,  </span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 运行时环境，默认是nodejs的node。因为我们部署的是二进制可执行文件，所以不需要编译器</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;exec_interpreter&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 运行模式，pm2支持cluster和fork两种模式。</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// cluster模式，可以由pm2做负载均衡，但是只支持nodejs应用，</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 所以如果是非nodejs应用，这里只能配置成fork</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;exec_mode&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;fork&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// javascript中的析构语法，相当于把ENV对象嵌入到这个对象里</span></span>
<span class="line"><span style="color:#D4D4D4;">      ...</span><span style="color:#4FC1FF;">ENV</span></span>
<span class="line"><span style="color:#D4D4D4;">    },</span></span>
<span class="line"><span style="color:#D4D4D4;">  ],</span></span>
<span class="line"><span style="color:#D4D4D4;">  </span><span style="color:#9CDCFE;">deploy:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 部署test环境相关配置，可以配置任意多个任意名称的环境，</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#6A9955;">// 比如uat，beta，release，production等等</span></span>
<span class="line"><span style="color:#D4D4D4;">    </span><span style="color:#9CDCFE;">test:</span><span style="color:#D4D4D4;"> {</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 可以配置多个ip地址，同时部署到多台测试服务器</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">host:</span><span style="color:#D4D4D4;"> [</span><span style="color:#CE9178;">&#39;162.14.116.92&#39;</span><span style="color:#D4D4D4;">],</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 服务器用户名</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">user:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;root&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// ssh相关配置</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">ssh_options:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;StrictHostKeyChecking=no&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 要部署的代码分支</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">ref:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&#39;origin/master&#39;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// git clone命令的代码仓库地址</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">repo:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;git@github.com:unionj-cloud/go-doudou-tutorials.git&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 代码的服务器磁盘路径</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#9CDCFE;">path:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;/root/deploy/go-doudou-tutorials&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// post-deploy回调命令</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#6A9955;">// 这里配置的命令的意思是切到usersvc路径下，然后执行deploy.sh脚本，传入test参数</span></span>
<span class="line"><span style="color:#D4D4D4;">      </span><span style="color:#CE9178;">&quot;post-deploy&quot;</span><span style="color:#9CDCFE;">:</span><span style="color:#D4D4D4;"> </span><span style="color:#CE9178;">&quot;cd usersvc &amp;&amp; sh deploy.sh test&quot;</span><span style="color:#D4D4D4;">,</span></span>
<span class="line"><span style="color:#D4D4D4;">    }</span></span>
<span class="line"><span style="color:#D4D4D4;">  }</span></span>
<span class="line"><span style="color:#D4D4D4;">};</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h3 id="deploy-sh脚本" tabindex="-1"><a class="header-anchor" href="#deploy-sh脚本" aria-hidden="true">#</a> deploy.sh脚本</h3><p><code>deploy.sh</code>脚本的作用是编译go代码，生成二进制可执行文件，设置时区环境变量，最后执行<code>pm2 restart</code>命令启动或重启服务。请参考下面的注释帮助理解。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="shiki" style="background-color:#1E1E1E;"><code><span class="line"><span style="color:#6A9955;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 设置编译程序所需环境变量</span></span>
<span class="line"><span style="color:#6A9955;"># 开启go module</span></span>
<span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> GO111MODULE=on</span></span>
<span class="line"><span style="color:#6A9955;"># 设置goproxy，加快依赖下载速度</span></span>
<span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> GOPROXY=https://goproxy.cn,direct</span></span>
<span class="line"><span style="color:#6A9955;"># 编译程序，生成可执行文件</span></span>
<span class="line"><span style="color:#D4D4D4;">go build -v -o api cmd/main.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 因为本案例的代码里用到了go标准库time包，里面的time.Local静态变量会从TZ环境变量中取值，</span></span>
<span class="line"><span style="color:#6A9955;"># 如果没有配置此环境变量，则取默认值UTC时区，这通常不符合我们的需求</span></span>
<span class="line"><span style="color:#569CD6;">export</span><span style="color:#D4D4D4;"> TZ=</span><span style="color:#CE9178;">&quot;Asia/Shanghai&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955;"># 通过pm2启动服务进程，--only表示只部署usersvc应用，--env表示读取配置文件中ENV属性中的</span></span>
<span class="line"><span style="color:#6A9955;"># env_dev、env_prod、env_test中的哪一个，注意传参时不加env_前缀</span></span>
<span class="line"><span style="color:#6A9955;"># pm2 restart命令是在服务器上执行的命令，与pm2 deploy命令有本质区别</span></span>
<span class="line"><span style="color:#D4D4D4;">pm2 restart ecosystem.config.js --only usersvc --env </span><span style="color:#9CDCFE;">$1</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本文我们首先介绍了pm2进程管理工具的主要功能和相比docker的优劣势，然后介绍了为部署go语言写的应用需要对服务器做的前期准备工作，最后我们通过一个实战案例演示了部署流程，并且讲解了pm2相关的配置文件和部署脚本。相信各位gopher已经掌握了通过pm2部署go-doudou服务的方法。在下一期文章，我会再拿一个Java生态的spring boot框架写的服务和go-doudou写的服务构成微服务的案例演示如何用pm2部署微服务。</p><h2 id="参考链接" tabindex="-1"><a class="header-anchor" href="#参考链接" aria-hidden="true">#</a> 参考链接</h2><ul><li>pm2官方配置文件文档：<a href="https://pm2.keymetrics.io/docs/usage/application-declaration/" target="_blank" rel="noopener noreferrer">https://pm2.keymetrics.io/docs/usage/application-declaration/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a></li><li>pm2官方部署文档：<a href="https://pm2.keymetrics.io/docs/usage/deployment/" target="_blank" rel="noopener noreferrer">https://pm2.keymetrics.io/docs/usage/deployment/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span></a></li></ul><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/unionj-cloud/go-doudou/edit/main/zh/blog/pm2.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">在新窗口打开</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wubinwill@gmail.com">武斌</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.2025f35b.js" defer></script>
  </body>
</html>
